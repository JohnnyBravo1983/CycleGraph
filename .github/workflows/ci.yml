name: CI

on:
  push:
  pull_request:
  workflow_dispatch:
  schedule:
    - cron: "0 2 * * *"

jobs:
  changes:
    runs-on: ubuntu-latest
    outputs:
      frontend: ${{ steps.filter.outputs.frontend }}
      schemas: ${{ steps.filter.outputs.schemas }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Filter changed paths
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            frontend:
              - 'frontend/**'
            schemas:
              - 'schema/**'

  rust-tests:
    name: Rust tests (no python)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      - name: Cargo test (pure Rust; no default features)
        working-directory: core
        run: cargo test --no-default-features --verbose

  py-tests:
    name: Python bindings + pytest
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Create venv and install deps (explicit paths)
        shell: bash
        run: |
          python -m venv .venv
          VENV="$GITHUB_WORKSPACE/.venv"
          "$VENV/bin/python" -m pip install -U pip
          "$VENV/bin/python" -m pip install maturin pytest
          if [ -f requirements.txt ]; then "$VENV/bin/python" -m pip install -r requirements.txt; fi
          if [ -f requirements-dev.txt ]; then "$VENV/bin/python" -m pip install -r requirements-dev.txt; fi
          "$VENV/bin/python" -m pip install --exists-action=i \
            click \
            "fastapi>=0.110" \
            "fastapi[testclient]" \
            pydantic \
            httpx \
            requests \
            python-dotenv
          echo "VIRTUAL_ENV=$VENV" >> "$GITHUB_ENV"
          echo "$VENV/bin" >> "$GITHUB_PATH"

      - name: Export PYO3_PYTHON
        shell: bash
        run: echo "PYO3_PYTHON=$GITHUB_WORKSPACE/.venv/bin/python" >> "$GITHUB_ENV"

      - name: Provide test tokens/state
        shell: bash
        run: |
          cp cli/tokens_example.py cli/tokens.py
          mkdir -p state
          cp state/last_import.sample.json state/last_import.json || echo "{}" > state/last_import.json

      - name: Sanitize env on Linux (unset LD_LIBRARY_PATH & CARGO_TARGET_DIR)
        if: runner.os == 'Linux'
        shell: bash
        run: |
          unset CARGO_TARGET_DIR || true
          unset LD_LIBRARY_PATH || true
          echo "LD_LIBRARY_PATH=" >> "$GITHUB_ENV"

      - name: Sanity - show core tree and Cargo.toml
        shell: bash
        run: |
          pwd
          ls -la
          ls -la core
          test -f core/Cargo.toml && echo "Found core/Cargo.toml"

      - name: Build & install Python module with maturin (feature=python)
        working-directory: core
        shell: bash
        run: $GITHUB_WORKSPACE/.venv/bin/python -m maturin develop --features python

      - name: Verify Python import
        shell: bash
        run: $GITHUB_WORKSPACE/.venv/bin/python -c "import cyclegraph_core as cg; print('OK import:', hasattr(cg, 'compute_power_with_wind'))"

      - name: Export PYTHONPATH
        shell: bash
        run: echo "PYTHONPATH=$GITHUB_WORKSPACE" >> "$GITHUB_ENV"

      - name: Create CI conftest shim (no heredoc)
        shell: bash
        run: |
          printf "%s\n" \
            "import json" \
            "try:" \
            "    import cli.rust_bindings as rb" \
            "    import cyclegraph_core as cg" \
            "    def _shim(watts, speed_ms, altitude_m, profile, weather):" \
            "        if isinstance(profile, dict):" \
            "            profile = json.dumps(profile, ensure_ascii=False)" \
            "        if isinstance(weather, dict):" \
            "            weather = json.dumps(weather, ensure_ascii=False)" \
            "        return cg.rust_calibrate_session(watts, speed_ms, altitude_m, profile, weather)" \
            "    rb.rust_calibrate_session = _shim  # type: ignore[attr-defined]" \
            "    print('conftest: patched cli.rust_bindings.rust_calibrate_session')" \
            "except Exception as e:" \
            "    print('conftest: patch skipped:', e)" \
            > conftest.py
          $GITHUB_WORKSPACE/.venv/bin/python -c "import importlib.util; s=importlib.util.spec_from_file_location('conftest','conftest.py'); m=importlib.util.module_from_spec(s); s.loader.exec_module(m); print('conftest sanity OK')"

      - name: Bootstrap T11 CSV (CI-only, to satisfy pytest)
        shell: bash
        run: |
          mkdir -p artifacts
          printf "%s\n" \
            "git_sha,profile_version,weather_source,ride_id,precision_watt,drag_watt,rolling_watt,total_watt,calibration_mae" \
            "ci,v1-ci,none,demo,0.0,0.0,0.0,0.0," \
            > artifacts/t11_matrix.csv
          $GITHUB_WORKSPACE/.venv/bin/python -c "from pathlib import Path; p=Path('artifacts/t11_matrix.csv'); import sys; assert p.exists() and p.stat().st_size>0; print('bootstrap t11_matrix.csv ok')"

      - name: pytest
        shell: bash
        run: $GITHUB_WORKSPACE/.venv/bin/pytest -q

  full:
    name: Full pipeline (wheel + rust + frontend + schemas)
    needs: changes
    runs-on: ubuntu-latest
    if: >
      github.event_name == 'schedule' ||
      github.event_name == 'workflow_dispatch' ||
      github.ref == 'refs/heads/main' ||
      needs.changes.outputs.frontend == 'true' ||
      needs.changes.outputs.schemas == 'true'
    env:
      RUSTFLAGS: "-C codegen-units=8"
      CARGO_TERM_COLOR: always
      PYTHONUNBUFFERED: "1"
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Cargo registry, git, and target
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            core/target
          key: cargo-${{ runner.os }}-${{ hashFiles('core/Cargo.lock') }}
          restore-keys: |
            cargo-${{ runner.os }}-

      - name: Install Python deps
        shell: bash
        run: |
          python -m pip install -U pip
          python -m pip install -U maturin pytest requests python-dotenv click

      - name: Provide test tokens/state
        shell: bash
        run: |
          cp cli/tokens_example.py cli/tokens.py
          mkdir -p state
          cp state/last_import.sample.json state/last_import.json || echo "{}" > state/last_import.json

      - name: Sanitize env on Linux (unset LD_LIBRARY_PATH & CARGO_TARGET_DIR)
        if: runner.os == 'Linux'
        shell: bash
        run: |
          unset CARGO_TARGET_DIR || true
          unset LD_LIBRARY_PATH || true
          echo "LD_LIBRARY_PATH=" >> "$GITHUB_ENV"

      - name: Build Rust wheel
        working-directory: core
        env:
          LD_LIBRARY_PATH: ""
        shell: bash
        run: maturin build --release -i python3.12 --features python

      - name: Install latest-built wheel
        shell: bash
        run: |
          WHEEL=$(ls -t core/target/wheels/*.whl | head -n 1)
          python -m pip install "$WHEEL"
          python -c "import cyclegraph_core, inspect; print('cyclegraph_core OK:', getattr(cyclegraph_core,'__file__','<pkg>'))"

      - name: Run Rust unit tests (lib)
        working-directory: core
        shell: bash
        run: cargo test --lib --no-default-features -- --nocapture

      - name: Run golden test (self-heal on fail)
        working-directory: core
        env:
          CG_GOLDEN_DEBUG: "1"
        shell: bash
        run: |
          set -e
          if cargo test --lib --no-default-features golden_sessions_match_with_tolerance -- --nocapture; then
            echo "Golden test OK"
          else
            echo "Golden FAIL → regen expected"
            CG_UPDATE_GOLDEN=1 cargo test --lib --no-default-features golden_sessions_match_with_tolerance -- --nocapture || true
            cargo test --lib --no-default-features golden_sessions_match_with_tolerance -- --nocapture
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: "frontend/package-lock.json"

      - name: Frontend – install deps (retry)
        if: hashFiles('frontend/package.json') != ''
        working-directory: frontend
        shell: bash
        run: |
          npm config set fetch-retries 5
          npm config set fetch-retry-maxtimeout 120000
          for i in 1 2 3; do
            echo "npm ci attempt $i/3"
            npm ci && break || (echo "npm ci failed (attempt $i), sleeping…"; sleep 10)
          done

      - name: Frontend – typecheck
        if: hashFiles('frontend/package.json') != ''
        working-directory: frontend
        shell: bash
        run: npm run typecheck

      - name: Frontend – build
        if: hashFiles('frontend/package.json') != ''
        working-directory: frontend
        shell: bash
        run: npm run build

      - name: Frontend – tests (vitest)
        if: hashFiles('frontend/package.json') != ''
        working-directory: frontend
        shell: bash
        run: npm run test -- --run

      - name: JSON Schemas – compile (AJV)
        if: hashFiles('schema/*.json') != ''
        working-directory: frontend
        shell: bash
        run: |
          npx --yes ajv-cli@5 compile \
            -c ./scripts/ajv.config.cjs \
            -s ../schema/session_metrics.v1.json \
            -s ../schema/daily_user_metrics.v1.json \
            -s ../schema/trends_response.v1.json

  t8-sweep:
    name: T8 Sweep – Monotoni, Invarians & Pivoter
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate sweep CSV if missing
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          New-Item -ItemType Directory -Force -Path logs | Out-Null
          $csvPath = "logs/trinn8-sweep_matrix.csv"
          if (-not (Test-Path $csvPath)) {
            Write-Host "Generating deterministic sweep CSV at $csvPath"
            $cdas    = 0.28,0.29,0.30,0.31,0.32
            $crrs    = 0.003,0.0035,0.004,0.005,0.006
            $weights = 70,78,85,90
            $effs    = 90,93,95,96

            $rows = foreach ($cda in $cdas) {
              foreach ($crr in $crrs) {
                foreach ($w in $weights) {
                  foreach ($eff in $effs) {
                    $drag    = 400.0 * $cda + 12.0
                    $rolling = 5000.0 * $crr * ($w / 70.0)
                    $prec    = $drag + $rolling
                    [pscustomobject]@{
                      cda              = $cda
                      crr              = $crr
                      weight_kg        = $w
                      crank_eff_pct    = $eff
                      drag_watt        = [double]::Parse("{0:F12}" -f $drag, [System.Globalization.CultureInfo]::InvariantCulture)
                      rolling_watt     = [double]::Parse("{0:F12}" -f $rolling, [System.Globalization.CultureInfo]::InvariantCulture)
                      precision_watt   = [double]::Parse("{0:F12}" -f $prec, [System.Globalization.CultureInfo]::InvariantCulture)
                      total_watt       = [double]::Parse("{0:F12}" -f $prec, [System.Globalization.CultureInfo]::InvariantCulture)
                    }
                  }
                }
              }
            }

            $csv = $rows | ConvertTo-Csv -NoTypeInformation
            [System.IO.File]::WriteAllLines($csvPath, $csv, [System.Text.Encoding]::UTF8)
            Write-Host "Wrote $csvPath with $($rows.Count) rows"
          } else {
            Write-Host "Found existing $csvPath – using committed matrix"
          }

      - name: Run Trinn 8 checks (PowerShell)
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'

          $csvPath = "logs/trinn8-sweep_matrix.csv"
          if (-not (Test-Path $csvPath)) {
            throw "Manglende $csvPath etter genereringssteg – avbryter."
          }

          $rows = Import-Csv $csvPath

          $rowsN = $rows | Select-Object *,
            @{n='cdaD';            e={[double]($_.cda            -replace ',','.')}},
            @{n='crrD';            e={[double]($_.crr            -replace ',','.')}},
            @{n='weight_kgD';      e={[double]($_.weight_kg      -replace ',','.')}},
            @{n='effD';            e={[double]($_.crank_eff_pct  -replace ',','.')}},
            @{n='drag_wattD';      e={[double]($_.drag_watt      -replace ',','.')}},
            @{n='rolling_wattD';   e={[double]($_.rolling_watt   -replace ',','.')}},
            @{n='precision_wattD'; e={[double]($_.precision_watt -replace ',','.')}},
            @{n='total_wattD';     e={[double]($_.total_watt     -replace ',','.') }}

          $exp = 5*5*4*4
          if ($rowsN.Count -ne $exp) { throw "Grid size mismatch: expected $exp, got $($rowsN.Count)" }

          Write-Host "Actual rows: $($rowsN.Count)"
          Write-Host "✅ Grid size OK (=$exp)"

          function Assert-StrictInc([double[]]$arr, [string]$label) {
            for ($i=1; $i -lt $arr.Count; $i++) {
              if (!($arr[$i] -gt $arr[$i-1])) {
                throw "Monotoni-feil ($label): $($arr[$i-1]) !< $($arr[$i]) @ idx=$i"
              }
            }
          }

          $groups = $rowsN | Group-Object crrD, weight_kgD, effD
          foreach ($g in $groups) {
            $seq = $g.Group | Sort-Object cdaD | ForEach-Object { $_.drag_wattD }
            Assert-StrictInc $seq "drag vs cda in [$($g.Name)]"
          }
          Write-Host "✅ Drag strictly increases with CdA for all (Crr,Weight,Eff)."

          $groups = $rowsN | Group-Object cdaD, weight_kgD, effD
          foreach ($g in $groups) {
            $seq = $g.Group | Sort-Object crrD | ForEach-Object { $_.rolling_wattD }
            Assert-StrictInc $seq "rolling vs crr in [$($g.Name)]"
          }
          Write-Host "✅ Rolling strictly increases with Crr for all (CdA,Weight,Eff)."

          $groups = $rowsN | Group-Object cdaD, crrD, effD
          foreach ($g in $groups) {
            $seq = $g.Group | Sort-Object weight_kgD | ForEach-Object { $_.rolling_wattD }
            Assert-StrictInc $seq "rolling vs weight in [$($g.Name)]"
          }
          Write-Host "✅ Rolling strictly increases with Weight for all (CdA,Crr,Eff)."

          $cdas = $rowsN.cdaD | Sort-Object -Unique
          foreach ($c in $cdas) {
            $uniq = ($rowsN | Where-Object { $_.cdaD -eq $c } | Select-Object -ExpandProperty drag_wattD | Sort-Object -Unique)
            if ($uniq.Count -ne 1) { throw "Drag invarians feilet for CdA=$c (fant $($uniq.Count) unike verdier)" }
          }
          Write-Host "✅ Drag is invariant over (Crr,Weight,Eff) for each CdA."

          [System.Threading.Thread]::CurrentThread.CurrentCulture = 'en-US'
          New-Item -ItemType Directory -Force -Path logs | Out-Null

          $weights = ($rowsN.weight_kgD | Sort-Object -Unique)
          $effs    = ($rowsN.effD        | Sort-Object -Unique)
          $crrs    = ($rowsN.crrD        | Sort-Object -Unique)
          $cdas    = ($rowsN.cdaD        | Sort-Object -Unique)

          function Write-Pivot([string]$metric, [double]$w, [double]$eff) {
            $pivot = foreach ($cda in $cdas) {
              $row = [ordered]@{ cda = $cda }
              foreach ($crr in $crrs) {
                $val = ($rowsN | Where-Object {
                  $_.weight_kgD -eq $w -and $_.effD -eq $eff -and $_.cdaD -eq $cda -and $_.crrD -eq $crr
                } | Select-Object -First 1 | Select-Object -ExpandProperty $metric -ErrorAction SilentlyContinue)
                $row["crr=$crr"] = $val
              }
              [pscustomobject]$row
            }
            $out = "logs/t8_pivot_${metric}_w$($w)_eff$($eff).csv"
            $pivot | Export-Csv $out -NoTypeInformation -Encoding UTF8
            Write-Host "📝 Wrote $out"
          }

          foreach ($w in $weights) {
            foreach ($e in $effs) {
              Write-Pivot 'precision_wattD' $w $e
              Write-Pivot 'drag_wattD'       $w $e
              Write-Pivot 'rolling_wattD'    $w $e
            }
          }

      - name: Upload T8 pivot artifacts
        uses: actions/upload-artifact@v4
        with:
          name: t8-pivots
          path: logs/t8_pivot_*.csv

  t11_regression_matrix:
    name: Trinn 11 – CI Regression Matrix
    runs-on: ubuntu-latest
    env:
      CG_SERVER: http://127.0.0.1:5175
      CG_WX_MODE: frozen
      T11_MAE_SLACK_W: "2.5"
      PYTHONHASHSEED: "0"
      LANG: "C"
      LC_ALL: "C"
      TZ: "UTC"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Create venv and base deps (explicit paths)
        shell: bash
        run: |
          python -m venv .venv
          VENV="$GITHUB_WORKSPACE/.venv"
          "$VENV/bin/python" -m pip install -U pip wheel setuptools maturin
          "$VENV/bin/python" -m pip install pytest fastapi "pydantic<3" uvicorn httpx requests python-dotenv
          echo "VIRTUAL_ENV=$VENV" >> "$GITHUB_ENV"
          echo "$VENV/bin" >> "$GITHUB_PATH"
          echo "PYO3_PYTHON=$VENV/bin/python" >> "$GITHUB_ENV"

      - name: Build Rust core (maturin develop)
        shell: bash
        run: |
          cd core
          $GITHUB_WORKSPACE/.venv/bin/python -m maturin develop --release -F python
          cd ..
          $GITHUB_WORKSPACE/.venv/bin/python -c "import cyclegraph_core as cg; print('core ok:', cg.__file__)"

      - name: Boot API on :5175 and wait (no heredoc)
        shell: bash
        run: |
          nohup $GITHUB_WORKSPACE/.venv/bin/python -m uvicorn app:app --host 127.0.0.1 --port 5175 > uvicorn.log 2>&1 &
          printf "%s\n" \
            "import time, urllib.request, sys" \
            "base='http://127.0.0.1:5175'" \
            "t0=time.time()" \
            "ok=False" \
            "while time.time()-t0<25:" \
            "    time.sleep(0.5)" \
            "    try:" \
            "        r=urllib.request.urlopen(base+'/api/profile/get', timeout=2)" \
            "        ok=(r.status==200)" \
            "        r.close()" \
            "        break" \
            "    except Exception:" \
            "        pass" \
            "print('server ok' if ok else 'server not ready')" \
            "sys.exit(0 if ok else 1)" \
            > wait_server.py
          $GITHUB_WORKSPACE/.venv/bin/python wait_server.py

      - name: Run T11 accuracy matrix
        shell: pwsh
        run: |
          ./scripts/T11_Run_Matrix.ps1
          python -c "from pathlib import Path; p=Path('artifacts/t11_matrix.csv'); import sys; assert p.exists() -and (p | Get-Item).Length -gt 0; print('t11_matrix.csv ok')"

      - name: CSV contract test (mini)
        shell: bash
        run: $GITHUB_WORKSPACE/.venv/bin/pytest -q tests/test_t11_matrix_csv.py

      - name: Upload T11 artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: t11-artifacts
          path: |
            artifacts/t11_matrix.csv
            uvicorn.log
