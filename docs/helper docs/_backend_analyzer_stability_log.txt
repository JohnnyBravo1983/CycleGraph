ğŸ§© Backend Analyzer Stability â€“ oppdatert og merget (t.o.m. Trinn 6)

(Uendret i hovedsak; beholdt for helhet. Nye/endrede punkter er merket med ğŸ†• / ğŸŸ¦ Trinn 4 / ğŸŸ¨ Trinn 5 / ğŸŸ© Trinn 6.)

1. MiljÃ¸ og installasjon
$env:PYTHONPATH = ""
cd core
python -m maturin develop --release -F python
cd ..
python -c "import cyclegraph_core as cg; print('core ok:', cg.__file__)"


âœ… Resultat: Fullt deterministisk miljÃ¸ â€“ uavhengig av conda eller globale pakker.

2. Import-skygge og API-konsistens

(uendret fra Trinn 3â€“5)
Bekreftet signatur og fallback-logikk i cli/__init__.py.

SIG = (watts, hr, device_watts=None)
MODULE = cli.init

3. Analyzer-forbedringer og profil-sensitivitet

Uendret; monotoni verifisert for CdA, Crr og weight.
Respons- og profil-sensitivitet som fÃ¸r.

4. Kontrakt og kjerneadaptere

Rust-adapter og API-kontrakt fortsatt standardisert.

ğŸ†• (Trinn 4) Weather i payload (OBJECT)
ğŸ†• (Trinn 4) Heading og Ï verifisert â‰ˆ 1.225
ğŸŸ¨ (Trinn 5) Device-heuristikker og crank_eff innfÃ¸rt
ğŸŸ© (Trinn 6) Kalibreringsfelt og CI-logging lagt til

Nytt etter Trinn 6 (passiv kalibrering):

metrics inneholder nÃ¥ ogsÃ¥ calibration_mae, calibrated, calibration_status (alltid tilstede).

analyze_session kan motta device_watts i samples for MAE-beregning.

Feature-flag CG_CALIBRATE=1 aktiverer CSV-logging til logs/trinn6-manual_sanity.csv.

Fallback: calibrated=false, status="not_available" hvis ingen device-data eller Rust-funksjon.

Ingen endring i Rust-ABI eller payload-kontrakt; fullt bakoverkompatibelt.

5. Test- og valideringsmal

Uendret monotoni-test fra Trinn 3 + Trinn 4 vÃ¦rtest.

ğŸŸ© (Trinn 6) Nytt test- og proof-sett:

scripts/T6_Smoke_NoDevice.py og T6_Smoke_WithDevice.py verifiserer felt og MAE.

Output eksempel: False not_available None â†’ True ok 45.08.

NÃ¥r CG_CALIBRATE=1 skrives resultater til logs/trinn6-manual_sanity.csv.

Bekreftet stabil import og ingen endring i Rust-baner ([SVR]/[RB]/[DBG] grÃ¸nt).

6. CI- og miljÃ¸sikring

CI-setup uendret fra Trinn 4, men nÃ¥ utvidet med kalibrerings-logg.

ğŸŸ© (Trinn 6) CI forberedt pÃ¥ automatisk kalibrerings-logging uten validering.

CG_CALIBRATE=1 â†’ kun logging, ingen asserts.

rust_calibrate_session kan aktiveres senere uten endring av API.

calibration_mae og calibrated kan brukes som primÃ¦r-mÃ¥l for Trinn 11 (Regression Matrix).

ğŸ§© Resultat (samlet status)
Element	Status	Kommentar
rust_calibrate_session eksport	âœ…	Stub forberedt (ikke aktiv)
JSON â†” dict in-sync	âœ…	Kontrakt utvidet med kalibreringsfelt
analyze_session (array)	âœ…	Uendret signatur, foroverkompatibel
precision_watt-sensitivitet	âœ…	CdA/Crr/weight som fÃ¸r
calibration felter	âœ…	Felt og logging implementert (Tr6)
Seeding og persist	âœ…	Som Tr3
Type- og retur-garantier	âœ…	float/bool/string utvidet kontrakt
pytest- og smoke-tester	âœ…	Alle passerte
MiljÃ¸-determinisme	âœ…	.venv isolert
CI-kompatibilitet	âœ…	Logging til fil aktiv
Nominal metrics	âœ…	Fungerer uendret
Debug-felt/kontrakt	âœ…	Foroverkompatible
compute_power_with_wind_json (1-arg)	âœ…	Standardisert
source	âœ…	rust_1arg
Tr5: device/binding/effekt	âœ…	Heuristisk skalering aktiv
ğŸŸ© Tr6: calibration/CI	âœ…	MAE + logging ferdig
ğŸ”® Fremoverkompabilitet (Trinn 4â€“9)
Trinn	Tema	Foroverkomp.-notater
4	Calibrated Physics + Weather API	Weather i payload; heading CW fra nord; aggregater i metrics.
5	Device Heuristics & Fallback	profile.device stabil; rideâ†’profil-binding.
6	Calibration & CI	Feltene calibrated, calibration_mae, calibration_status garanteres; feature-flag for logging; Rust kan aktiveres senere uten API-endring.
7	Publish & Observability	Logg precision_watt, drag_watt, rolling_watt, total_watt, calibration_mae, calibrated, profile_used, weather_applied, source, repr_kind, weather_source.
8	Verification & Sweep	Automatisk sweep av parametre og sanity check pÃ¥ lange Ã¸kter > 2 t; nominal deaktiveres i real-runs.
9	Trend Analysis	AggregÃ©r pÃ¥ profil-versjon og ride-ID; ikke miks profiler uten versjon-tag.
10	Profile Versioning & Audit Trail	Bruk versjon-tag som primÃ¦rnÃ¸kkel for historiske sammenligninger.
11	CI Regression Matrix	Bruk calibration_mae og precision_watt som hovedmÃ¥l; CI sjekker at endringer ikke Ã¸ker MAE > terskel.
12	Heuristic Expansion	Utvid device-stÃ¸tte med flere enheter; Strava forblir default.
13	Export & API Stability	Stabiliser repr_kind/source/metrics/profile_used.
14	Final Sweep & Lock	Full sweep av alle rides + profiler; deterministisk lukking av sprint.
ğŸŸ¨ Trinn 5 â€“ Device Heuristics & Profile Binding

(uendret fra forrige versjon, beholdt for helhet.)

ğŸŸ© Trinn 6 â€“ Calibration & CI (Preparation Phase)

MÃ¥l: Forberede rammeverk for kalibrering og nÃ¸yaktighetsmÃ¥ling.

Leveranser:

Kalibreringsfelt lagt til i metrics.

Passiv device-stÃ¸tte og MAE-beregning.

Feature-flag CG_CALIBRATE=1 for CSV-logging.

Rust-stub forberedt men ikke aktiv.

Testet via smoke-scripts og sanity-CSV.

Resultat:
âœ… Backend og API stabile etter utvidelse.
âœ… Fremtidige Trinn 7â€“11 kan bruke samme kontrakt uten kodeendring.

ğŸ“‹ Endringer lagt til i denne versjonen

ğŸŸ© Trinn 6-seksjon lagt til (med felter, feature-flag og logging).

Oppdaterte fremoverkompatibilitetstabellen med Trinn 6â€“14.

Utvidet test- og CI-seksjon med Trinn 6 rÃ¸yk- og CSV-logging.

Ingen andre deler endret â€“ alt fra Trinn 3â€“5 beholdt uforandret




ğŸ§­ Forward-Compatibility Schema (for Copilot context)

(oppdatert t.o.m. Trinn 6)

Purpose:
Fast, maskinlesbart referansepunkt for backend-kontrakten etter Trinn 6.
(Plasseres alltid til slutt, oppdateres per trinn.)

Adapter & Core Binding

Adapter: cli/rust_bindings.rs_power_json
Kallsti: 1-arg kjernesignatur â†’ compute_power_with_wind_json(payload_json)

Payload-invariant (etter Trinn 6)
{
  "samples": [
    {
      "t": <float>,
      "v_ms": <float>,
      "device_watts": <float?>,     // ğŸŸ© valgfritt â€“ brukes for MAE-beregning
      "...": "..."
    }
  ],
  "profile": {
    "cda": <float>,
    "crr": <float>,
    "weight_kg": <float>,
    "crank_eff_pct": <float>,
    "device": "strava" | "<other>"
  },
  "weather": {
    "wind_ms": <float>,
    "wind_dir_deg": <0â€“360>,
    "air_temp_c": <float>,
    "air_pressure_hpa": <float>
  }
}


Minimikrav samples: t, v_ms (heading kan ligge i samples eller beregnes fÃ¸r kall).
Weather-enheter: wind_ms [m/s], wind_dir_deg [0â€“360 CW fra nord], air_temp_c [Â°C], air_pressure_hpa [hPa].
Valgfri probe/telemetri: __probe: "rb-1arg".

Stable Contract Keys (retur)
Kategori	NÃ¸kler
Lister (len = samples)	v_ms, v_rel, watts, wind_rel
Skalarer	precision_watt, total_watt, weather_applied, source, repr_kind
Aggregater (metrics)	drag_watt, rolling_watt, precision_watt, total_watt, profile_used
ğŸŸ© Kalibrering	calibration_mae, calibrated, calibration_status
Toleranse	toppnivÃ¥ drag_watt/rolling_watt/gravity_watt kan vÃ¦re null i 1-arg; bruk metrics-aggregater
Debug / Telemetri (Foroverkompatible)

source âˆˆ {"rust_1arg","fallback_py"}
(valgfritt) binding, repr_kind, weather_source
debug.ignored_persist, debug.reason

Guardrails

Kall alltid kjerne via adapter (rs_power_json).

Hold heading og vind i samme referanseramme.

Ikke antag per-sample komponentserier i 1-arg; les aggregater fra metrics.

metrics.profile_used mÃ¥ inkludere cda, crr, weight_kg, crank_eff_pct, device, profile_version.

Tr5: device beholdes urÃ¸rt (default = "strava").

ğŸŸ© Tr6: metrics skal alltid inneholde calibration_mae, calibrated, calibration_status â€“ selv ved nullverdier.

ğŸŸ© Feature-flag CG_CALIBRATE=1 aktiverer logging til logs/trinn6-manual_sanity.csv.

Bruk schema-snapshot-test for Ã¥ fange felt-/type-/lengdeendringer.

Fremoverkompabilitet (Trinn 4â€“9)
Trinn	Tema	Foroverkomp.-notater
4	Weather i payload; 1-arg aggregater i metrics	Verifisert heading CW fra nord; Ï â‰ˆ 1.225
5	Device-heuristikker (strava: moving/grade) + rideâ†’profile_version + heuristisk crank_eff i Python	Beholder foroverkomp. mot Rust
ğŸŸ© 6	Calibration & CI	Feltene calibration_mae, calibrated, calibration_status skal alltid vÃ¦re tilstede; device_watts valgfritt; feature-flag for logging; Rust-stub kan aktiveres uten API-endring
7	Publish & Observability	Logg precision_watt, drag_watt, rolling_watt, total_watt, calibration_mae, calibrated, profile_used, weather_applied, source, repr_kind, weather_source
8â€“9	Sweep / Trend Analysis	Valider MAE og ytelsestrender per profile_version
ğŸ“‹ Differ / Nye tillegg fra Trinn 6

ğŸŸ© device_watts felt lagt til i samples (for passiv kalibrering).

ğŸŸ© Tre nye felter i metrics: calibration_mae, calibrated, calibration_status (alltid tilstede).

ğŸŸ© CG_CALIBRATE feature-flag beskrevet under Guardrails.

ğŸŸ© Utvidet fremoverkomp.-tabell med Trinn 6 rad og feltene for Trinn 7â€“9 som avhenger av MAE/CI-logging.

Ellers ingen endring i eksisterende payload eller ABI â†’ full bakoverkompatibilitet bevart.