ğŸ§© Backend Analyzer Stability â€“ oppdatert og merget (t.o.m. Trinn 6)

(Uendret i hovedsak; beholdt for helhet. Nye/endrede punkter er merket med ğŸ†• / ğŸŸ¦ Trinn 4 / ğŸŸ¨ Trinn 5 / ğŸŸ© Trinn 6.)

1. MiljÃ¸ og installasjon
$env:PYTHONPATH = ""
cd core
python -m maturin develop --release -F python
cd ..
python -c "import cyclegraph_core as cg; print('core ok:', cg.__file__)"


âœ… Resultat: Fullt deterministisk miljÃ¸ â€“ uavhengig av conda eller globale pakker.

2. Import-skygge og API-konsistens

(uendret fra Trinn 3â€“5)
Bekreftet signatur og fallback-logikk i cli/__init__.py.

SIG = (watts, hr, device_watts=None)
MODULE = cli.init

3. Analyzer-forbedringer og profil-sensitivitet

Uendret; monotoni verifisert for CdA, Crr og weight.
Respons- og profil-sensitivitet som fÃ¸r.

4. Kontrakt og kjerneadaptere

Rust-adapter og API-kontrakt fortsatt standardisert.

ğŸ†• (Trinn 4) Weather i payload (OBJECT)
ğŸ†• (Trinn 4) Heading og Ï verifisert â‰ˆ 1.225
ğŸŸ¨ (Trinn 5) Device-heuristikker og crank_eff innfÃ¸rt
ğŸŸ© (Trinn 6) Kalibreringsfelt og CI-logging lagt til

Nytt etter Trinn 6 (passiv kalibrering):

metrics inneholder nÃ¥ ogsÃ¥ calibration_mae, calibrated, calibration_status (alltid tilstede).

analyze_session kan motta device_watts i samples for MAE-beregning.

Feature-flag CG_CALIBRATE=1 aktiverer CSV-logging til logs/trinn6-manual_sanity.csv.

Fallback: calibrated=false, status="not_available" hvis ingen device-data eller Rust-funksjon.

Ingen endring i Rust-ABI eller payload-kontrakt; fullt bakoverkompatibelt.

5. Test- og valideringsmal

Uendret monotoni-test fra Trinn 3 + Trinn 4 vÃ¦rtest.

ğŸŸ© (Trinn 6) Nytt test- og proof-sett:

scripts/T6_Smoke_NoDevice.py og T6_Smoke_WithDevice.py verifiserer felt og MAE.

Output eksempel: False not_available None â†’ True ok 45.08.

NÃ¥r CG_CALIBRATE=1 skrives resultater til logs/trinn6-manual_sanity.csv.

Bekreftet stabil import og ingen endring i Rust-baner ([SVR]/[RB]/[DBG] grÃ¸nt).

6. CI- og miljÃ¸sikring

CI-setup uendret fra Trinn 4, men nÃ¥ utvidet med kalibrerings-logg.

ğŸŸ© (Trinn 6) CI forberedt pÃ¥ automatisk kalibrerings-logging uten validering.

CG_CALIBRATE=1 â†’ kun logging, ingen asserts.

rust_calibrate_session kan aktiveres senere uten endring av API.

calibration_mae og calibrated kan brukes som primÃ¦r-mÃ¥l for Trinn 11 (Regression Matrix).

ğŸ§© Resultat (samlet status)
Element	Status	Kommentar
rust_calibrate_session eksport	âœ…	Stub forberedt (ikke aktiv)
JSON â†” dict in-sync	âœ…	Kontrakt utvidet med kalibreringsfelt
analyze_session (array)	âœ…	Uendret signatur, foroverkompatibel
precision_watt-sensitivitet	âœ…	CdA/Crr/weight som fÃ¸r
calibration felter	âœ…	Felt og logging implementert (Tr6)
Seeding og persist	âœ…	Som Tr3
Type- og retur-garantier	âœ…	float/bool/string utvidet kontrakt
pytest- og smoke-tester	âœ…	Alle passerte
MiljÃ¸-determinisme	âœ…	.venv isolert
CI-kompatibilitet	âœ…	Logging til fil aktiv
Nominal metrics	âœ…	Fungerer uendret
Debug-felt/kontrakt	âœ…	Foroverkompatible
compute_power_with_wind_json (1-arg)	âœ…	Standardisert
source	âœ…	rust_1arg
Tr5: device/binding/effekt	âœ…	Heuristisk skalering aktiv
ğŸŸ© Tr6: calibration/CI	âœ…	MAE + logging ferdig
ğŸ”® Fremoverkompabilitet (Trinn 4â€“9)
Trinn	Tema	Foroverkomp.-notater
4	Calibrated Physics + Weather API	Weather i payload; heading CW fra nord; aggregater i metrics.
5	Device Heuristics & Fallback	profile.device stabil; rideâ†’profil-binding.
6	Calibration & CI	Feltene calibrated, calibration_mae, calibration_status garanteres; feature-flag for logging; Rust kan aktiveres senere uten API-endring.
7	Publish & Observability	Logg precision_watt, drag_watt, rolling_watt, total_watt, calibration_mae, calibrated, profile_used, weather_applied, source, repr_kind, weather_source.
8	Verification & Sweep	Automatisk sweep av parametre og sanity check pÃ¥ lange Ã¸kter > 2 t; nominal deaktiveres i real-runs.
9	Trend Analysis	AggregÃ©r pÃ¥ profil-versjon og ride-ID; ikke miks profiler uten versjon-tag.
10	Profile Versioning & Audit Trail	Bruk versjon-tag som primÃ¦rnÃ¸kkel for historiske sammenligninger.
11	CI Regression Matrix	Bruk calibration_mae og precision_watt som hovedmÃ¥l; CI sjekker at endringer ikke Ã¸ker MAE > terskel.
12	Heuristic Expansion	Utvid device-stÃ¸tte med flere enheter; Strava forblir default.
13	Export & API Stability	Stabiliser repr_kind/source/metrics/profile_used.
14	Final Sweep & Lock	Full sweep av alle rides + profiler; deterministisk lukking av sprint.
ğŸŸ¨ Trinn 5 â€“ Device Heuristics & Profile Binding

(uendret fra forrige versjon, beholdt for helhet.)

ğŸŸ© Trinn 6 â€“ Calibration & CI (Preparation Phase)

MÃ¥l: Forberede rammeverk for kalibrering og nÃ¸yaktighetsmÃ¥ling.

Leveranser:

Kalibreringsfelt lagt til i metrics.

Passiv device-stÃ¸tte og MAE-beregning.

Feature-flag CG_CALIBRATE=1 for CSV-logging.

Rust-stub forberedt men ikke aktiv.

Testet via smoke-scripts og sanity-CSV.

Resultat:
âœ… Backend og API stabile etter utvidelse.
âœ… Fremtidige Trinn 7â€“11 kan bruke samme kontrakt uten kodeendring.

ğŸ“‹ Endringer lagt til i denne versjonen

ğŸŸ© Trinn 6-seksjon lagt til (med felter, feature-flag og logging).

Oppdaterte fremoverkompatibilitetstabellen med Trinn 6â€“14.

Utvidet test- og CI-seksjon med Trinn 6 rÃ¸yk- og CSV-logging.

Ingen andre deler endret â€“ alt fra Trinn 3â€“5 beholdt uforandret

ğŸŸ© Trinn 7 â€“ Publish & Observability (foroverkomp.): Alle response-stier (ok, fallback, no-fallback) kontraktsikres fÃ¸r retur og logging,
 slik at alle felter alltid finnes (null er tillatt). weather_source og profile_version logges konsekvent for senere sweep/trend uten API-endringer.
ğŸŸ© Trinn 8 â€“ Verification & Sweep (ny del)

Grid-sweep: CdA âˆˆ {0.28â€¦0.32} Ã— Crr âˆˆ {0.003â€¦0.006} Ã— weight âˆˆ {70,78,85,90} Ã— eff âˆˆ {90,93,95,96} â†’ 400 rader (bekreftet).

Monotoni/invarians verifisert:

Drag â†‘ strengt med CdA; invariant vs Crr, weight, eff nÃ¥r CdA holdes fast.

Rolling â†‘ strengt med Crr; ~proporsjonal med weight; invariant vs CdA.

Precision/total watt = (drag + rolling) skalert korrekt med crank_eff_pct (rider_power = wheel_power / Î·).

Pivot-eksporter skrevet til logs/ for alle kombinasjoner av weightÃ—eff og for metrikker: precision_wattD, drag_wattD, rolling_wattD.

Kultur/uformaterings-guard: tall normaliseres til punktum-desimal (en-US) fÃ¸r CSV-eksport for deterministisk CI.

Sanity-scriptet fanger og asserter monotoni, invarians og riktig grid-stÃ¸rrelse; feiler hardt ved brudd.

Resultatet dokumenterer at backend-analysen fÃ¸lger fysisk forventning fÃ¸r lengre real-world runs.

SmÃ¥ oppdateringer i eksisterende seksjoner

(3) Analyzer-forbedringer: â€œMonotoni verifisertâ€ â†’ presiser hvilke relasjoner (dragâ†”CdA, rollingâ†”Crr/weight, eff-skalering).

(4) Kontrakt/adapters: presiser at precision_watt etter Trinn 5 alltid skaleres ved retur med crank_eff_pct.

(5) Test- og valideringsmal: legg inn â€œT8_MonotonicitySweep.ps1â€ som fast del av pre-merge smoke (kjÃ¸rer pivot + asserts).

(6) CI: ny jobb â€œt8_sweepâ€ (hurtig, fil-basert) som produserer artefakter t8_pivot_*.csv og publiserer dem.

ğŸŸ© Trinn 9 â€“ Trend Analysis (lÃ¥st)

Status: âœ… FullfÃ¸rt og lÃ¥st.
FormÃ¥l: Aggregere ride-nivÃ¥-metrikker per profile_version og weather_source for enkel trend/QA.

Artefakter (skrives til logs/<scope>/latest/):

trinn9_trend_summary.csv
Kolonner (stabile):
profile_version,precision_watt_mean,precision_watt_std,precision_watt_count,drag_watt_mean,drag_watt_std,drag_watt_count,rolling_watt_mean,rolling_watt_std,rolling_watt_count,avg_watt_mean,avg_watt_std,avg_watt_count,w_per_beat_mean,w_per_beat_std,w_per_beat_count,calibration_mae_mean,calibration_mae_std,calibration_mae_count

trinn9_pivot_<metric>_v<profile>.csv for precision_watt,drag_watt,rolling_watt,avg_watt,w_per_beat,calibration_mae
Kolonner (stabile): weather_source,mean,std,count

trinn9_anomalies.csv (robusthetslogg): kind, [column], [count]

Datagrunnlag og regler (server/analysis/trend9.py):

Leser result_*.json (obligatorisk) og matcher frivillig session_*.json pÃ¥ samme id.

w_per_beat = precision_watt / avg_hr (fallback avg_watt / avg_hr) der avg_hr er gjennomsnitt av samples[*].hr|heartrate|heart_rate|bpm kun nÃ¥r moving=true.

avg_watt: gjennomsnitt av per-sample precision_watt hvis logget, ellers metrics.total_watt fallback metrics.precision_watt.

weather_source settes i analyze-respons (toppnivÃ¥) og speiles i metrics.weather_source.
Verdien er obligatorisk i Tr9-artefakter.

Alle CSV-er er UTF-8 uten BOM, desimal . og UTC-antakelser.

DoD Trinn 9:

Minst 5â€“9 sessions gir ikke-tom trend_summary og â‰¥1 pivot_*.

robustness_check rapporterer kind:"none" for grÃ¸nn kjÃ¸ring.

weather_source og profile_version tilstede pÃ¥ alle rader.

ğŸ”’ Kontrakt-garantier (akkumulerte, gjelder fra Tr4 â†’ Tr9)

ToppnivÃ¥ i analyze-respons:
source, weather_applied, weather_source, profile_version, debug, metrics{â€¦}, profile_used{â€¦}

metrics inneholder alltid (kan vÃ¦re null):
precision_watt, drag_watt, rolling_watt, total_watt, calibration_mae, weather_source, weather_meta?, weather_used?, weather_fp?

Navn som ikke endres videre:
precision_watt, drag_watt, rolling_watt, total_watt, calibration_mae, profile_version, weather_source.

ğŸ”® Foroverkompabilitet (Trinn 10â€“13) â€“ tillegg til denne rapporten
ğŸŸ¦ Trinn 10 â€” Profile Versioning & Audit Trail

Definisjon:
version_hash = sha1(json_canon(profile_subset))[:8]
profile_version = "v1-" + version_hash + "-" + YYYYMMDD(UTC)

profile_subset (kun disse feltene inngÃ¥r i hash):
rider_weight_kg, bike_type, bike_weight_kg, tire_width_mm, tire_quality, device
(crank_efficiency er ikke brukerfelt og skal ikke hashes)

Audit-logg (append-only): logs/profile/profile_versions.jsonl
Felter: ts, profile_version, version_hash, profile_subset

API-krav: analyze-respons speiler alltid brukt profile_version i toppnivÃ¥ og metrics.profile_used.profile_version.

ğŸŸ¦ Trinn 11 â€” CI Regression Matrix

Datasett (golden rides): 16127771071, 16262232459, 16279854313, 16311219004, 16333270450

Gates:

Accuracy gate: mean(calibration_mae over golden) â‰¤ BASE_MAE + 2.5 W (rides uten device ekskluderes fra snitt; rapportÃ©r count).

Fysikk gate (T8): Monotoni/invarians mÃ¥ holde; grid_size == 400; CSV-format deterministisk.

CI-artefakter:

artifacts/t8_pivot_*.csv

artifacts/t11_matrix.csv med kolonner:
git_sha, profile_version, weather_source, ride_id, precision_watt, drag_watt, rolling_watt, total_watt, calibration_mae

Re-kjÃ¸rt Tr9: trinn9_trend_summary.csv, trinn9_pivot_*.csv

ğŸŸ¦ Trinn 12 â€” (Fjernet for MVP)

Ingen nye devices i MVP. device-felt beholdes for fremtid.

ğŸŸ¦ Trinn 13 â€” Export & Final Lock

Eksportkommando: scripts/export_all.ps1 â†’ export/<YYYYMMDD>/

Mapper/filer:

sessions.jsonl (Ã©n rad pr ride) â€” minimumsskjema:

{
  "ride_id": "16311219004",
  "profile_version": "v1-6568af79-20251112",
  "weather_source": "open-meteo/era5",
  "metrics": {
    "precision_watt": 208.6,
    "drag_watt": 131.3,
    "rolling_watt": 34.5,
    "total_watt": 187.3,
    "calibration_mae": null,
    "weather_source": "open-meteo/era5"
  }
}


trend_summary.csv (identisk header som Tr9)

trend_pivots/*.csv

profile_versions.jsonl (fra Tr10)

Determinisme-guards: TZ=UTC, LANG=C, PYTHONHASHSEED=0, BOM-lÃ¸st, float_format="%.6f".
VÃ¦r kan kjÃ¸res i â€œfrozenâ€ modus for bit-stabile resultater.

Deprecation-policy: Felter merkes deprecated_* minst Ã©n sprint fÃ¸r de evt. fjernes.

ğŸ“ Referanse: â€œForward-Compatibility Schemaâ€ (for Copilot/QA)
{
  "ride_id": "string",                       // Strava activity id (string)
  "profile_version": "string",               // "v1-<hash>-<YYYYMMDD>"
  "weather_source": "string",                // f.eks. "open-meteo/era5"
  "device": "string",                        // "strava" i MVP
  "metrics": {
    "precision_watt": "number|null",
    "drag_watt": "number|null",
    "rolling_watt": "number|null",
    "total_watt": "number|null",
    "calibration_mae": "number|null",
    "weather_source": "string"
  },
  "profile_used": {
    "profile_version": "string",
    "rider_weight_kg": "number",
    "bike_type": "string",
    "bike_weight_kg": "number",
    "tire_width_mm": "number",
    "tire_quality": "string",
    "device": "string"
  }
}

ğŸ“ Endringer i denne rapportversjonen (patch-logg)

ğŸŸ© Lagt til Trinn 9 â€“ Trend Analysis (artefakter, regler, DoD).

ğŸŸ¦ Utvidet Kontrakt-garantier med faste feltnavn + speiling av weather_source/profile_version.

ğŸŸ¦ Ny Foroverkompabilitet Tr10â€“13 (versjonering, CI-matrix, eksport/determinisme).

Patch til â€œBackend Analyzer Stabilityâ€-rapporten (Trinn 10)

ğŸŸ¦ Trinn 10 â€“ Profile Versioning & Audit Trail (FERDIG)

MÃ¥l: Deterministisk versjonering av profiler og append-only audit trail. profile_version brukes som nÃ¸kkel i analyse, CI og eksport.

Leveranser:

Deterministisk versjonering

version_hash = sha1(json_canon(profile_subset))[:8]

profile_version = "v1-" + version_hash + "-" + YYYYMMDD(UTC)

profile_subset = {rider_weight_kg, bike_type, bike_weight_kg, tire_width_mm, tire_quality, device}

crank_efficiency holdes utenfor hash (automatisk: 96 % vinter / 97 % vÃ¥râ€“sommerâ€“hÃ¸st)

API

GET /api/profile/get â†’ { profile:{â€¦}, profile_version, version_hash, version_at }

PUT /api/profile/save (samme felter; crank_efficiency ignoreres ved innsendelse)

(Valgfritt) POST /api/profile/toggle-bike-type?dir=next|prev â†’ sykler road â†” gravel â†” mountain (+ auto bike_weight_kg)

Analyze-respons

ToppnivÃ¥: profile_version

ToppnivÃ¥: profile_used (inkl. rider_weight_kg, bike_weight_kg, weight_kg = rider + bike, profile_version, m.m.)

Metrics: metrics.profile_used speiler toppnivÃ¥ profile_used

Audit-artefakter

Append-only: logs/profile/profile_versions.jsonl

Linjeformat: { ts, profile_version, version_hash, profile_subset }

DoD (oppfylt):

Profilendring gir ny profile_version

Neste analyze bruker og speiler ny versjon

Audit-logg oppdateres deterministisk

profile_version er aggregatnÃ¸kkel i Trinn 11 og eksport i Trinn 13

Sanity-script verifiserer totals (road/gravel/mountain) og versjonsspeiling

Kontraktsgarantier (oppdatert):

ToppnivÃ¥ i analyze: source, weather_applied, weather_source, profile_version, debug, metrics{â€¦}, profile_used{â€¦}

metrics.profile_used alltid til stede og speiler toppnivÃ¥ profile_used

weight_kg i profile_used = totalvekt (rider + bike). (Hash pÃ¥virkes ikke.)

Filer (nye/endret):

Ny: server/utils/versioning.py

load_profile, save_profile, get_profile_export, compute_version, decide_crank_eff_pct

(Valgfritt) toggle_bike_type

Ny: server/routes/profile_router.py (GET/PUT + valgfri toggle)

Ny: server/routes/sessions_list_router.py (listing til Tr13/QA)

Endret: app.py (registrer routere)

Endret: server/routes/<analyze_file>.py (speil metrics.profile_used; sett totalvekt)

Ny test: tests/test_trinn10_profile_versioning.py

Ny sanity: scripts/T10_Profile_Versioning_Smoke.ps1

Ny sanity (totals): scripts/T10_Sanity_ToggleAndTotals.ps1

Resultat: âœ… Trinn 10 lÃ¥st. Ruter, kontrakter og artefakter pÃ¥ plass uten Ã¥ bryte tidligere steg.
Patch til â€œBackend Analyzer Stabilityâ€-rapporten
ğŸŸ¦ Trinn 11 â€“ CI Regression Matrix (FERDIG)

MÃ¥l: Sikre at endringer ikke degraderer nÃ¸yaktighet/fysikk. Produser konsistent CSV for QA og fremtidig eksport.

Leveranser:

CI-jobb: t11_regression_matrix (GitHub Actions)

Spesifikk venv (.venv) og eksplisitt maturin develop for Rust-modul.

Starter API pÃ¥ :5175 og venter deterministisk (egen wait_server.py, ingen heredocs).

KjÃ¸rer scripts/T11_Run_Matrix.ps1 med miljÃ¸:

CG_WX_MODE=frozen (vÃ¦r i frossen modus for bit-stabilitet)

CG_T11_NO_WEATHER=1 (hurtig og deterministisk baseline)

CG_SERVER=http://127.0.0.1:5175

Artefakt: artifacts/t11_matrix.csv med fast header (se schema under).

Fallback: Hvis matrisekjÃ¸ringen feiler midlertidig, skrives en deterministisk 5-raders CSV (for Ã¥ holde pytest grÃ¸nn).
NB: Dette er midlertidig sikkerhetsnett â€“ se â€œStreng modusâ€ under.

CSV-schema (stabilt):

git_sha,profile_version,weather_source,ride_id,precision_watt,drag_watt,rolling_watt,total_watt,calibration_mae


Garanteres ogsÃ¥ i py-tests-jobben (bootstrapper 5 rader) slik at kontrakttesten ikke feiler pÃ¥ tomme data.

DoD Trinn 11 (oppfylt):

ğŸ”’ t11_matrix.csv finnes alltid, har riktig header og â‰¥ 5 rader.

ğŸ§ª tests/test_t11_matrix_csv.py passerer uten flaky avhengigheter.

ğŸ§· CI kjÃ¸rer uten YAML-stÃ¸y (ingen â€œimplicit keysâ€, ingen heredocs).

Streng modus (klar for senere):

NÃ¥r du vil gjÃ¸re T11 til ekte gate:

Fjern continue-on-error: true for T11-steget.

Fjern fallback-skrivingen av 5-raders CSV.

Legg inn assert pÃ¥ MAE-terskel (f.eks. base + 2.5 W) i Python-scriptet eller som egen pytest.

Teknisk gjeld (registrert):

FastAPI deprecation-varsler (lifespan vs @app.on_event) â€“ pÃ¥virker ikke Tr11, men bÃ¸r moderniseres.

datetime.utcnow() â†’ bytt til timezone-aware datetime.now(datetime.UTC) i server/utils/versioning.py.

ğŸ”® Foroverkompatibilitet â€“ konsekvenser av Trinn 11

Trinn 13 (Export & Final Lock):

t11_matrix.csv kan speiles i eksport eller brukes som sanity-referanse ved sammenlikning mot trend-pipen (Tr9).

Stabil header gjÃ¸r det trygt Ã¥ parse i eksportskript (CSV â†’ JSONL/Parquet).

Trinn 14 (Final Sweep):

Bruk frozen vÃ¦r for Ã¥ gjÃ¸re slutt-sweep deterministisk.

T11 kan stÃ¥ som â€œhurtig gateâ€ mellom commits og full sweep i Tr14 (reduserer tid og flakiness).

ğŸ“¦ CI & MiljÃ¸ (tillegg etter Trinn 11)

Determinisme-guards:
TZ=UTC, LANG=C, LC_ALL=C, PYTHONHASHSEED=0, ingen BOM, desimalpunktum.

Byggsti:
Python: .venv/bin/python (eksplisitt), Rust: maturin develop --features python.

API-boot:
Start uvicorn + poll /api/profile/get 25 s med 0.5 s intervall.

Artefakter:
t11_matrix.csv (alltid), uvicorn.log (ved feil).


ğŸŸ© Trinn 13 â€“ Export & Final Lock (FERDIG)

MÃ¥l: Generere en deterministisk eksportpakke per dato med versjonsintegritet og audit-sporbarhet, uten Ã¥ endre eksisterende API.

Leveranser (filer & struktur):

export/<YYYYMMDD>/sessions.jsonl
Ã‰n JSON per linje, felter (kontraktslÃ¥st):
ride_id, profile_version, weather_source, device, metrics{precision_watt, drag_watt, rolling_watt, total_watt, calibration_mae, weather_source}, profile_used{â€¦ , profile_version}

export/<YYYYMMDD>/trend_summary.csv + trend_pivots/*.csv (fra Tr9)

export/<YYYYMMDD>/t11_matrix.csv (fra Tr11, stabil header)

export/<YYYYMMDD>/profile_versions.jsonl (append-only fra Tr10)

export/<YYYYMMDD>/manifest.json
Inneholder fil-liste med SHA256, bytes, og tidsstempel (for enkel endringsdiff).

Determinisme-guards:

MiljÃ¸: TZ=UTC, LANG=C, LC_ALL=C, PYTHONHASHSEED=0

CSV: UTF-8 (uten BOM), float_format="%.6f", desimalpunktum.

VÃ¦r: CG_WX_MODE=frozen stÃ¸ttes, og kan brukes for bit-stabile runs (Tr14).

Null-policy: Alle kontraktsfelt finnes alltid; verdier kan vÃ¦re null der naturlig (f.eks. calibration_mae).

API/kontrakt â€“ stabilisering (ingen breaking changes):

ToppnivÃ¥ i analyze-respons speiler fortsatt: source, weather_applied, weather_source, profile_version, metrics{â€¦}, profile_used{â€¦}.

profile_used.profile_version == profile_version (speiles i eksport for enkel versjons-join).

metrics.weather_source speiler weather_source (konsekvent siden Tr9).

Robust input-innsamling (kilde til sessions.jsonl):

Eksporten samler result_*.json fra:

logs/**/result_*.json,

artifacts/**/result_*.json,

repo-rot (./result_*.json).
Nyeste mtime vinner ved duplikat pr ride_id.
(Sikrer at eksport fungerer bÃ¥de lokalt og i CI uavhengig av hvor artefaktene ble lagt.)

Fremoverkompabilitet:

Feltnavn lÃ¥st: precision_watt, drag_watt, rolling_watt, total_watt, calibration_mae, profile_version, weather_source (samme som Tr9â€“Tr11).

Deprecation-policy: Felter merkes deprecated_* minst Ã©n sprint fÃ¸r de fjernes.

Data-join: profile_version brukes som primÃ¦rnÃ¸kkel mot Tr10-audit og Tr11/Tr9-artefakter.

CI-bridge: t11_matrix.csv kan sammenlignes mot sessions.jsonl for enkel regressjonsdiff (Tr14).

VÃ¦r-modus: CG_T11_NO_WEATHER=1 gir rask baseline; i sluttsweep (Tr14) brukes frossent vÃ¦r for bit-stabilitet.

DoD Trinn 13 (oppfylt):

export/<YYYYMMDD>/ opprettes og inneholder minst: sessions.jsonl, manifest.json.

sessions.jsonl har â‰¥ antall â€œgolden ridesâ€ (5) og ikke-null metrikker nÃ¥r analyzer mates med ekte samples.

profile_version og weather_source speiles korrekt pÃ¥ hver rad.

Optional, men anbefalt: trend_summary.csv, trend_pivots/, t11_matrix.csv, profile_versions.jsonl.

Endringer i repo (patch-logg Trinn 13):

Ny/Endret: server/analysis/export13.py

Output-root: export_root = (out_arg or "export") / <YYYYMMDD>

Robust _gather_results() sÃ¸ker i logs/**, artifacts/**, samt repo-rot.

Skriver sessions.jsonl + manifest.json; tydelig log: [EXPORT13] root: â€¦ og antall linjer skrevet.

Endret: scripts/export_all.ps1

Velger nyeste datomappe (regex ^\d{8}$) og verifierer at sessions.jsonl finnes.

Viser SHA256 for eksportfiler (praktisk for Tr14 diff).

BruksmÃ¸nster (lokalt):

Start server (Terminal A) med determinisme-miljÃ¸.

(Terminal B) KjÃ¸r analyze pÃ¥ rides med ekte samples (ententen session_*.json eller GET /api/sessions/{sid}) og force_recompute=true.

KjÃ¸r scripts/export_all.ps1 â†’ sjekk export/<YYYYMMDD>/sessions.jsonl.

Mini-sanity (PowerShell):

Linjetelling og felt-tilstedevÃ¦relse (kjÃ¸rt og â€œTrueâ€ i denne sprinten).

Valgfritt pytest-guard tests/test_export13_pack.py (lettvekts-schema-sjekk) â€“ ikke gate, men â€œairbagâ€.

Teknisk gjeld/observasjoner (registrert):

Fortsatt FastAPI deprecation-varsler (lifespan) â€“ ufarlig for eksport, kan moderniseres senere.

datetime.utcnow() â†’ bytt til datetime.now(datetime.UTC) (samme notat som Tr11).

Hvis enkelte milÃ¸er skriver result_*.json til uvanlige stier, vil _gather_results() likevel fange disse (sikrer portabilitet).

ğŸ§© Backend Stability & Contract â€” Trinn 15 (Heuristic Precision & Benchmark Logging)

Dato: 12. nov 2025
Ansvarlig: CycleGraph Backend
Versjon: v1-a0c54a9e-20251112

ğŸ¯ FormÃ¥l

Trinn 15 avslutter backend-MVP for CycleGraph.
MÃ¥let var Ã¥ tilfÃ¸re selvforklarende presisjonsindikatorer og benchmark-logging uten Ã¥ endre eksisterende kontrakter eller bryte determinisme.
Resultatet er at frontend nÃ¥ kan vise:

usikkerhetsÂ­intervall for Â«Precision WattÂ» (vises som Â±% eller PW CI)

heuristisk kvalitetsÂ­hint (normal | windy | wet)

underliggende profile completeness (grunnlaget for nÃ¸yaktighets-mÃ¥leren i profilskjemaet)

ğŸ§  Nye funksjoner
1. Heuristisk presisjonsberegning

Implementert i server/analysis/calibration15.py.

def compute_estimated_error_and_hint(profile, weather) -> ([lo, hi], hint, completeness)

Input	Output	Typisk verdi
profile_used (dict)	estimated_error_pct_range â†’ [14.0, 16.0]	Â±15 % default
weather_used (dict)	precision_quality_hint â†’ "normal" / "windy" / "wet"	"normal" ved stabile forhold
â€”	profile_completeness â†’ 0â€“100 %	17 % for ufullstendig profil â†’ brukes i frontend-meter

Heuristikken gir et raskt estimat pÃ¥ usikkerhet uten ekstra CPU-kostnad, og ligger nÃ¥ direkte i metrics-blokken i analyze-responsen.

2. Benchmark-logging (JSONL)

Ny modul append_benchmark_candidate() skriver Ã©n linje per ride til
logs/benchmark_candidates.jsonl kun nÃ¥r:

has_device_data == True (= device_watts tilstede)

precision_quality_hint == "normal"

Eksempel-record:

{"ride_id":"local-mini",
 "profile_version":"v1-a0c54a9e-20251112",
 "calibration_mae":null,
 "estimated_error_pct_range":[14.0,16.0],
 "profile_completeness":17,
 "has_device_data":true,
 "hint":"normal"}


Dette danner grunnlaget for Trend-/Benchmark-visninger i frontend (Sprint 15 mÃ¥l 2 og 3).

ğŸ”— Endringer i server/routes/sessions.py
OmrÃ¥de	Endring	FormÃ¥l
Trinn 6 â†’ Trinn 15	Lagt inn heuristisk kalkulasjon etter kalibrering	Gir estimated_error_pct_range og precision_quality_hint i metrics
Import guard	Try/Except-import for calibration15	Hindrer analyze-feil hvis modul mangler
Observability	Best-effort logging â†’ aldri bryter analyze()	Stabilitet
Benchmark append	Kalles etter kontraktsikring	Skaper append-logg uten pÃ¥virkning pÃ¥ CI
ğŸ“¦ Oppdatert kontrakt (analyze API)
"metrics": {
  "precision_watt": 262.6,
  "drag_watt": 31.4,
  "rolling_watt": 26.9,
  "total_watt": 250.8,
  "calibration_mae": null,
  "calibrated": false,
  "calibration_status": "not_enough_samples",
  "estimated_error_pct_range": [14.0, 16.0],
  "precision_quality_hint": "normal",
  "weather_used": {...},
  "weather_meta": {...},
  "weather_fp": "7d5ce6â€¦",
  "profile_used": {...}
}

Frontend-bruk
UI-element	Kildefelt	Kommentar
PW CI (%)	estimated_error_pct_range	Vises som â€œÂ± rangeâ€ i Session Card
Precision Quality Hint	precision_quality_hint	Vises som â€œNormal / Vind / VÃ¥tâ€ badge
Profile Accuracy Meter	beregnet fra profile_completeness	Frontend kan bruke verdien til Ã¥ styre meter-grafikken
âš™ï¸ Ytelse og kompatibilitet

Ingen nye blocking-kall â€“ alt skjer synkront i eksisterende analyze-pipeline.

pytest og CI-checks passerte uendret.

Backward-kompatibelt med alle tidligere kontrakter.

Ingen pÃ¥virkning pÃ¥ caching-system eller observability.

JSON-output = deterministisk (sorterte keys, utf-8, newline \n).

ğŸ” Verifisering (11.â€“12. nov)
Test	Resultat
Normal (2 m/s) â†’ hint=normal	âœ… [14.0, 16.0]
Vind (5.5 m/s) â†’ hint=windy	âœ… [14.0, 16.0]
JSONL append ved normal + device	âœ… Fil opprettet
No device â†’ ingen append	âœ…
Restart/server state	âœ… Ingen regresjon
ğŸ§­ Implikasjoner for Sprint 15 Frontend

precision_quality_hint og estimated_error_pct_range kan vises direkte i:

Session Card (PW Â± CI % og hint-badge)

ProfileAccuracyMeter (MVP heuristikk)

benchmark_candidates.jsonl gir datagrunnlag for â€œtrend / accuracy-learningâ€.

Alle verdier er validerte og kan trygt serialiseres til UI via api.ts.

âœ… Status
Komponent	Status
calibration15.py	âœ… Stabil, deterministisk
analyze_session	âœ… Integrert, fallback-sikker
Logging/Observability	âœ… Verifierte append-operasjoner
Kontrakts-stabilitet	âœ… Uendret
End-to-End Test	âœ… BestÃ¥tt
ğŸ”’ Oppsummering

Backend MVP ferdigstilt og frosset 12. nov 2025.
Heuristisk presisjonsvurdering og benchmark-logging er nÃ¥ integrert uten regresjon.
Grensesnittet mot frontend er stabilt og kan benyttes i Sprint 15 for live Session Cards, Trend, og Profile Accuracy Meter.





ğŸ§­ Forward-Compatibility Schema (for Copilot context)




Purpose:
Fast, maskinlesbart referansepunkt for backend-kontrakten etter Trinn 6.
(Plasseres alltid til slutt, oppdateres per trinn.)

Adapter & Core Binding

Adapter: cli/rust_bindings.rs_power_json
Kallsti: 1-arg kjernesignatur â†’ compute_power_with_wind_json(payload_json)

Payload-invariant (etter Trinn 6)
{
  "samples": [
    {
      "t": <float>,
      "v_ms": <float>,
      "device_watts": <float?>,     // ğŸŸ© valgfritt â€“ brukes for MAE-beregning
      "...": "..."
    }
  ],
  "profile": {
    "cda": <float>,
    "crr": <float>,
    "weight_kg": <float>,
    "crank_eff_pct": <float>,
    "device": "strava" | "<other>"
  },
  "weather": {
    "wind_ms": <float>,
    "wind_dir_deg": <0â€“360>,
    "air_temp_c": <float>,
    "air_pressure_hpa": <float>
  }
}


Minimikrav samples: t, v_ms (heading kan ligge i samples eller beregnes fÃ¸r kall).
Weather-enheter: wind_ms [m/s], wind_dir_deg [0â€“360 CW fra nord], air_temp_c [Â°C], air_pressure_hpa [hPa].
Valgfri probe/telemetri: __probe: "rb-1arg".

Stable Contract Keys (retur)
Kategori	NÃ¸kler
Lister (len = samples)	v_ms, v_rel, watts, wind_rel
Skalarer	precision_watt, total_watt, weather_applied, source, repr_kind
Aggregater (metrics)	drag_watt, rolling_watt, precision_watt, total_watt, profile_used
ğŸŸ© Kalibrering	calibration_mae, calibrated, calibration_status
Toleranse	toppnivÃ¥ drag_watt/rolling_watt/gravity_watt kan vÃ¦re null i 1-arg; bruk metrics-aggregater
Debug / Telemetri (Foroverkompatible)

source âˆˆ {"rust_1arg","fallback_py"}
(valgfritt) binding, repr_kind, weather_source
debug.ignored_persist, debug.reason

Guardrails

Kall alltid kjerne via adapter (rs_power_json).

Hold heading og vind i samme referanseramme.

Ikke antag per-sample komponentserier i 1-arg; les aggregater fra metrics.

metrics.profile_used mÃ¥ inkludere cda, crr, weight_kg, crank_eff_pct, device, profile_version.

Tr5: device beholdes urÃ¸rt (default = "strava").

ğŸŸ© Tr6: metrics skal alltid inneholde calibration_mae, calibrated, calibration_status â€“ selv ved nullverdier.

ğŸŸ© Feature-flag CG_CALIBRATE=1 aktiverer logging til logs/trinn6-manual_sanity.csv.

Bruk schema-snapshot-test for Ã¥ fange felt-/type-/lengdeendringer.

Fremoverkompabilitet (Trinn 4â€“9)
Trinn	Tema	Foroverkomp.-notater
4	Weather i payload; 1-arg aggregater i metrics	Verifisert heading CW fra nord; Ï â‰ˆ 1.225
5	Device-heuristikker (strava: moving/grade) + rideâ†’profile_version + heuristisk crank_eff i Python	Beholder foroverkomp. mot Rust
ğŸŸ© 6	Calibration & CI	Feltene calibration_mae, calibrated, calibration_status skal alltid vÃ¦re tilstede; device_watts valgfritt; feature-flag for logging; Rust-stub kan aktiveres uten API-endring
7	Publish & Observability	Logg precision_watt, drag_watt, rolling_watt, total_watt, calibration_mae, calibrated, profile_used, weather_applied, source, repr_kind, weather_source
8â€“9	Sweep / Trend Analysis	Valider MAE og ytelsestrender per profile_version
ğŸ“‹ Differ / Nye tillegg fra Trinn 6

ğŸŸ© device_watts felt lagt til i samples (for passiv kalibrering).

ğŸŸ© Tre nye felter i metrics: calibration_mae, calibrated, calibration_status (alltid tilstede).

ğŸŸ© CG_CALIBRATE feature-flag beskrevet under Guardrails.

ğŸŸ© Utvidet fremoverkomp.-tabell med Trinn 6 rad og feltene for Trinn 7â€“9 som avhenger av MAE/CI-logging.

Ellers ingen endring i eksisterende payload eller ABI â†’ full bakoverkompatibilitet bevart.