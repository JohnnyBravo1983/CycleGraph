Backend Analyzer Stability â€“ oppdatert og merget
ğŸ§© Trinn 3 â€“ Backend Analyzer Stability
1. MiljÃ¸ og installasjon
$env:PYTHONPATH = ""
Rebygget wheel via:
cd core
python -m maturin develop --release -F python
cd ..
Bekreftet stabile importveier:
python -c "import cyclegraph_core as cg; print('core ok:', cg.__file__)"
âœ… Resultat: Fullt deterministisk miljÃ¸ â€“ uavhengig av conda eller globalt installerte pakker.
2. Import-skygge og API-konsistens
Feilen i analyze_session() ble sporet til at cli/init.py re-eksporterte feil objekt.
Rett tiltak ble Ã¥ rydde i eksportene og sikre Ã©n tydelig wrapper for array-API-et som testene forventer.
Ny, test-vennlig eksport:
__all__ = ["cli", "analyze_session"]

try:
    from cyclegraph_core import analyze_session as _native_analyze_session
except Exception:
    _native_analyze_session = None
def analyze_session(watts, hr, device_watts=None):
    """Wrapper testene forventer (arrays-API)."""
    if not hr or len(watts) != len(hr):
        raise ValueError("Watt og puls mÃ¥ ha samme lengde; puls-listen kan ikke vÃ¦re tom")

    if _native_analyze_session is not None:
        return _native_analyze_session(watts, hr, (device_watts or 'powermeter'))

    try:
        from .rust_bindings import analyze_session as _rb_analyze
        return _rb_analyze(watts, hr, device_watts)
    except Exception:
        return 0.0
Denne implementasjonen:
Fjerner import-skygge fra cli.session_api
Beholder forventet signatur (watts, hr, device_watts=None)
Gir foroverkompatibel fallback dersom Rust-binding mangler
Kaster norsk ValueError ved ugyldig input
Bekreftet med introspeksjon:
SIG: (watts, hr, device_watts=None)
MODULE: cli.init
3. Analyzer-forbedringer og profil-sensitivitet
Under trinn 3 ble det utviklet et PowerShell-basert testframework som validerer variasjon i precision_watt, drag_watt, rolling_watt og total_watt ved endring av profilparametre.
Eksempelresultater etter backend-oppdatering:
CdA	Crr	W	precision_watt	drag_watt	rolling_watt	total_watt
0.28	0.004	78	189.7	147.0	29.1	184.1
0.32	0.004	78	208.6	168.0	29.1	205.1
0.28	0.006	78	202.8	147.0	43.6	198.6
0.28	0.004	90	193.7	147.0	33.5	188.6
Disse verdiene bekrefter at:
CdAâ†‘ â‡’ drag_wattâ†‘
Crrâ†‘ â‡’ rolling_wattâ†‘
weightâ†‘ â‡’ rolling_wattâ†‘
precision_watt varierer i takt med aero- og rullemotstand
Seeding-logikken kopierer nÃ¥ baseline-Ã¸kter (ride3.json) til unike case-IDer (ride3-c01, ride3-c02, â€¦), slik at alle testcaser fÃ¥r gyldige watt/puls-serier.
Dette eliminerer feilen:
Analyzer i 'series'-modus krever watts+puls (powermeter)
Responsen fra backend er nÃ¥ strukturert slik:

{
  "ok": true,
  "session_id": "ride3-test",
  "metrics": {
    "precision_watt": 208.6,
    "precision_watt_ci": 12.4,
    "drag_watt": 168.0,
    "rolling_watt": 29.1,
    "total_watt": 205.1,
    "aero_fraction": 0.66,
    "weather_applied": false,
    "profile_used": {
      "CdA": 0.32,
      "Crr": 0.004,
      "weight_kg": 78,
      "device": "strava"
    }
  },
  "debug": {
    "analyzer_mode": "series",
    "force_recompute": true,
    "ignored_persist": true,
    "reason": "ok"
  }
}
Dermed er precision_watt og relaterte metrics nÃ¥ profil-sensitiv i series-modus.
4. Nytt fra dette deltrinnet â€“ kontrakt og kjerneadaptere
ğŸ”¹ Rust-adapter og API-kontrakt

Opprettet Ã©n sentral Rust-adapter (cli/rust_bindings.rs_power_json) som erstatter alle direkte kall til compute_power_with_wind_json*.
Adapteren hÃ¥ndterer automatisk v3â†’v1â†’TRIPLE, serialiserer JSON og gir robust fallback.
server/routes/sessions.py bruker nÃ¥ adapteren eksklusivt, ingen direkte binding-kall.
ğŸ†• Oppdatering (denne chatten):
Adapteren er forenklet til kun 1-arg kallsti.
weather fjernet fra adapter-payload; kun estimat sendes nÃ¥r tredje argument brukes.
Dette sikrer at alle kall gÃ¥r via compute_power_with_wind_json (1-arg) â†’ full Rust-sti uten fallback.
ğŸ†• Bekreftet output (sanity):

"source": "rust_binding",
"used_fallback": false,
"debug": {
  "binding": "py_mod",
  "repr_kind": "legacy_tolerant",
  "weather_source": "neutral"
},
"metrics": {
  "drag_watt": 37.044,
  "rolling_watt": 18.3580488,
  "precision_watt": 55.4020488,
  "total_watt": 55.4020488
}
ğŸ”¹ Nominal metrics for tomme samples
(uendret)

ğŸ”¹ Debug-felt og kontraktssikring
debug.ignored_persist settes True nÃ¥r force=True.
debug.reason = "ok" alltid til stede.
metrics.total_watt garanteres (alias til precision_watt eller drag+rolling).
metrics.profile_used speiler innsendt profil, ikke scrubbed versjon.
weather_applied settes deterministisk basert pÃ¥ no_weather og vÃ¦rdata.
_ensure_contract_shape() sikrer at alle nÃ¸kler finnes selv ved fallback.

ğŸ†• Utvidelser (denne chatten):
Nye, foroverkompatible debug-nÃ¸kler: binding, repr_kind, weather_source.
ğŸ”¹ Kalibrering og fallback
rust_calibrate_session kaster ikke lenger hard feil ved manglende Rust-bygget kjerne; returnerer calibrated = False.
For CI fremover bÃ¸r det likevel legges inn feature-check for ekte Rust-binding.
(uendret, nÃ¥ verifisert kompatibel med tolerant parser)

5. Test- og valideringsmal (Trinn 3 â€œProof Scriptâ€)
Automatisk monotoni-sjekk for forventet retning:
if ($rows[1].drag -le $rows[0].drag) { Write-Host "Fail: CdAâ†‘ men drag ikke opp" -ForegroundColor Red }
if ($rows[2].roll -le $rows[0].roll) { Write-Host "Fail: Crrâ†‘ men roll ikke opp" -ForegroundColor Red }
if ($rows[3].roll -le $rows[0].roll) { Write-Host "Fail: Wâ†‘ men roll ikke opp" -ForegroundColor Red }


CSV-eksport til logs/trinn3-proof_*.csv
Echo fra log (â€œProfile used: CdA=â€¦, Crr=â€¦, weight=â€¦â€) for backend-verifikasjon.
Alle trinn testbare i isolasjon (PowerShell, pytest eller REST-kall).

âœ… Resultat: Full verifikasjon av profil-sensitivitet, vÃ¦r-avslag (no_weather=true) og robust recompute-logikk.
ğŸ†• Tillegg (denne chatten):
Eget debug-endepunkt POST /api/sessions/debug/rb for Ã¥ validere Rust-stien direkte (hurtig sanity ved fremtidige endringer).

6. CI- og miljÃ¸sikring
Alle tester kjÃ¸rer deterministisk i .venv.
CI-miljÃ¸et bruker identisk setup:
- name: Setup environment
  run: |
    python -m venv .venv
    .\.venv\Scripts\Activate.ps1
    python -m pip install -r requirements-ci.txt
    python -m maturin develop --release -F python
    pytest -q


Full ABI-stabilitet via PyTuple/PyDict-signaturer i core/src/py/mod.rs.
Testene for rust_calibrate_session og rust_calculate_weather_effects kan legges til uten binÃ¦rkompatibilitetsbrudd.
ğŸ†• Tillegg (denne chatten):
legacy_tolerant parsing i kjernen gir stabil kompilering og foroverkompatibilitet i CI.
Sjekk at compute_power_with_wind_json (1-arg) finnes fÃ¸r publisering.

ğŸ§© Resultat (samlet status)
Element	Status	Kommentar
rust_calibrate_session eksport	âœ…	Eksponert og verifisert
JSON â†” dict in-sync	âœ…	Ensartet returkontrakt Rust â†” Python
analyze_session (array-variant)	âœ…	Re-eksportert riktig fra cli.__init__.py
precision_watt-sensitivitet	âœ…	Varierer korrekt med CdA/Crr/weight
Seeding og persist	âœ…	Automatisk duplisering av baseline-Ã¸kter
Type- og retur-garantier	âœ…	cda, crr, mae = float; calibrated = bool
pytest-kjÃ¸ringer	âœ…	71 passerte, 0 feilet
MiljÃ¸-determinisme	âœ…	.venv isolert
CI-kompatibilitet	âœ…	Fullt reproduserbar setup
Nominal metrics	âœ…	Gir deterministisk fallback ved tomme samples
Debug-felt/kontrakt	âœ…	ignored_persist, reason, weather_applied sikres
ğŸ†• compute_power_with_wind_json (1-arg)	âœ…	NÃ¥ standardisert og brukt i alle kall
ğŸ†• source	âœ…	rust_binding, ikke lenger fallback
ğŸ†• debug-felter	âœ…	Utvidet med binding/repr_kind/weather_source
ğŸ†• fallback	âš™ï¸	Beholdt som failsafe, ikke aktiv
ğŸ†• metrics retur	âœ…	Full fra Rust; valideres via debug/rb
ğŸ”® Fremoverkompabilitet (Trinn 4â€“9)
Trinn	Tema	Foroverkompabilitetsnotater
4	Calibrated Physics + Weather API	ğŸ†• legacy_tolerant parser tillater nye vÃ¦rfelter uten signaturbrudd.
5	Device Heuristics & Fallback	ğŸ†• profile.device er stabil og kan brukes direkte i heuristikk.
6	Calibration & CI	ğŸ†• Feature-flag kan teste Rust-tilstedevÃ¦relse og logge repr_kind.
7	Publish & Observability	ğŸ†• Nye debug-felter kan logges for full trace av bindingsvei.
8	Verification & Sweep	ğŸ†• Deterministisk output fra Rust forenkler CI-sweeps.
9	Trend Analysis & Multi-Ride Testing	ğŸ†• Stabil profilbinding gir trygg aggregering over tid.
Ekstra tillegg (nytt fra trinn 3)
cli.analyze_session er nÃ¥ fullstendig test-isolert og kompatibel med alle fremtidige API-lag (REST/CLI/Service).
FastAPI/Starlette/httpx lÃ¥st til stabil 2025-kombinasjon.
Ny seeding-mekanisme gjÃ¸r testene uavhengige av eksisterende sesjonsdata.
force_recompute og no_weather gir deterministisk A/B-testing.
Profil-sensitiv analyse gir trygg overgang til vÃ¦r-pÃ¥-modus (Trinn 4).
Backend-strukturen er modulÃ¦r: metrics, physics, weather og device kan utvikles separat.
ğŸ†• Debug-endepunkt /api/sessions/debug/rb for rask validering av Rust-stien.
ğŸ§± Konklusjon
Denne utvidede sprinten gjenopprettet full stabilitet og profil-sensitivitet i analysemotoren.
Nytt i denne chatten: Rust-kall gÃ¥r nÃ¥ uten fallback via Ã©n-arg-adapter, debug-telemetri er utvidet, og kontrakten er foroverkompatibel.
Dette danner et solid grunnlag for roadmap-trinn 4â€“9:
ğŸŒ¤ï¸ Fysikk- og vÃ¦rintegrasjon (Trinn 4)
âš™ï¸ Device-heuristikk og fallback-logikk (Trinn 5)
ğŸ“ˆ Kalibrerings-CI og statistiske analyser (Trinn 6)
ğŸ“Š Observability og logging (Trinn 7)
âœ… Systematiske sanity-sweeps (Trinn 8)
ğŸ”„ Trendanalyse og multi-ride-aggregering (Trinn 9)







ğŸ§­ Forward-Compatibility Schema (for Copilot context)
Purpose:
Gir Copilot, test-pipelines og fremtidige trinn (4â€“9) et fast, maskinlesbart referansepunkt for backend-kontrakten slik den er stabilisert i Trinn 3.
Denne blokken oppdateres fortlÃ¸pende nÃ¥r kjerneendringer pÃ¥virker API, metrics eller bindings.
ğŸ§© Adapter & Core Binding
Adapter: cli/rust_bindings.rs_power_json
â†³ NÃ¥ lÃ¥st til 1-arg kjernesignatur: alltid compute_power_with_wind_json(payload_json).
Kallsti (oppdatert):
PrimÃ¦r: 1-arg OBJECT â†’ compute_power_with_wind_json (foretrukket og brukt).
(Beholdt kun som historikk/lesbarhet): v3/v1/TRIPLE omtales fortsatt i repo, men adapteren bruker ikke lenger v3/3-args.
Tredjeargument (oppdatert):
Kun estimat stÃ¸ttes/videresendes av adapteren nÃ¥r et tredje argument oppgis.
weather skal ikke legges pÃ¥ i denne stien (vÃ¦r hÃ¥ndteres separat i Trinn 4).
Estimat (for v3-historikk):
For tidligere v3-avhengigheter var estimat pÃ¥krevd; adapteren kan sette {} dersom fravÃ¦r, men nÃ¥ gÃ¥r alt via 1-arg.
âš ï¸ Fremover (uendret policy, presisert):
Alle kjernekall skal gÃ¥ via adapteren â€” ikke kall compute_power_with_wind_json* direkte utenom adapter.
Probe/telemetri (nytt):
Adapter kan legge __probe: "rb-1arg" i payload for sporbarhet i logs.
ğŸ“œ Stable Contract Keys (sessions.py)
debug.ignored_persist = True nÃ¥r force=True (beholder persist_ignored for legacy).
debug.reason = "ok" default i alle suksess-case.
metrics.total_watt = alias av precision_watt || (drag_watt + rolling_watt).
metrics.profile_used = inn-profilen (ikke scrubbed).
weather_applied settes deterministisk fra no_weather og vÃ¦rdata.
ğŸ†• Debug-felter (foroverkompatible):
debug.binding = "py_mod" (bindingsti)
debug.repr_kind = "legacy_tolerant" (tolerant parser i kjernen)
debug.weather_source = "neutral" (ingen vÃ¦r injisert via adapter)
ğŸ†• Kildefelt (presisering):
source = "rust_binding" nÃ¥r Rust-stien brukes, "fallback_py" ved fallback.
âš™ï¸ Nominal Metrics
Aktiveres kun nÃ¥r samples == 0.
Fyller drag_watt, rolling_watt, precision_watt fra fysikkformel (v = 6 m/s, Ï = 1.225).
Gir monotone tester og determinisme.
âš ï¸ Ikke bruk i produksjon hvis ekte data forventes.
ğŸ§ª Calibration Fallback
rust_calibrate_session returnerer struktur med calibrated=False nÃ¥r ikke kompilert.
âš ï¸ Trinn 6: legg inn CI-feature-flag som krever ekte Rust-kalibrering for regresjonstester.
ğŸ“± Device Handling
profile.device default = "strava".
Normaliseres og viderefÃ¸res urÃ¸rt.
âš ï¸ Trinn 5: heuristikker og profilbinding skal bruke akkurat denne nÃ¸kkelen.
ğŸ”  Profile Key Tolerance
StÃ¸tter bÃ¥de CdA/cda, Crr/crr, weight_kg/weightKg.
âš ï¸ Trinn 5: velg Ã©n kanonisk form (f.eks. snake_case) i storage, men behold input-toleranse.
ğŸŒ¦ï¸ Weather Flags & Telemetry
weather_applied = True hvis vÃ¦rdata brukes og ikke no_weather.
source fÃ¸lger binding/sti (se over).
âš ï¸ Trinn 7: standardiser og logg begge felter for ELK / dashboard.
ğŸ§¬ Profile Integrity
metrics.profile_used er nÃ¸yaktig det brukeren sendte inn.
âš ï¸ Trinn 5 / 9: bruk denne for profil-versjonering og trend-aggregering.

ğŸ§ª Debug & Sanity (nytt)
Endpoint: POST /api/sessions/debug/rb
Rask verifikasjon av Rust-stien (sender OBJECT med samples, profile, estimat, valgfritt __probe).
Bekrefter at adapter â†’ 1-arg â†’ Rust fungerer uten analyze-overhead.

ğŸ—ï¸ CI & Build (presisering)
Bruk maturin develop --release -F python i .venv.
Sjekk tilstedevÃ¦relse av compute_power_with_wind_json (1-arg) i CI fÃ¸r publisering.
Tolerant parser (legacy_tolerant) gjÃ¸r nye felt bakoverkompatible.

ğŸ§± Guardrails for Trinn 5â€“9
Trinn	Kjernekrav	Implementasjons-guardrail
5 Device Heuristics	Les profile.device; lagre profil i kanonisk form og bind rideâ†’profil-versjon (1â€“5).	Behold input-profilen urÃ¸rt; ikke overstyr device.
6 Calibration & CI	Feature-flag krever Rust tilgjengelig; CI feiler uten.	Logg calibration_mae, calibrated; ikke skjul fallback. Verifiser 1-arg funksjon.
7 Publish & Observability	Logg precision_watt, drag_watt, rolling_watt, total_watt, profile_used, weather_applied, source, reason.	Bruk serde_json::Value / â€œfree formâ€ for utvidelse. Ta med binding, repr_kind, weather_source.
8 Verification & Sweep	Deaktiver nominal for ekte varians.	Dokumenter nÃ¥r nominal aktiveres (samples == 0).
9 Trend Analysis	Aggreger pÃ¥ profil-versjon + ride-ID.	Ikke miks profiler uten versjon-tag.
Mini-referanse for Copilot (maskinlesbart hint)
Adapter invariant: payload keys âŠ‡ { "samples", "profile" } + (valgfritt) "estimat", aldri "weather" i adapter-stien.
Debug-minstekrav: reason, ignored_persist, binding, repr_kind.
Kildefelt: source âˆˆ {"rust_binding","fallback_py"}.
Kontrakt-stabilitet: nye felt kan legges under debug og metrics uten signaturendring.