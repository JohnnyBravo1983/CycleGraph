üß™ QUICK START (to vinduer)

Vindu A (server):

# Fra repo-roten
powershell -NoProfile -ExecutionPolicy Bypass -File .\scripts\tools\start_api.ps1 -Port 5179


Vindu B (klient):

# Publiser ride3 rett ut (viser respons)
powershell -NoProfile -ExecutionPolicy Bypass -File .\scripts\tools\publish_ride.ps1 -SessionId ride3 -AnalyzeFirst


Hvis token er utl√∏pt/f√∏rstegang:

# Les client info fra .env (juster evt. STRAVA_CLIENT_ID/REDIRECT om ikke lastet)
$env:STRAVA_CLIENT_ID = "171819"
$env:STRAVA_REDIRECT_URI = "http://127.0.0.1:5179/api/debug/oauth_capture"

# Bygg authorize URL
$redirEnc = [uri]::EscapeDataString($env:STRAVA_REDIRECT_URI)
$scope = "read,activity:read,activity:read_all,activity:write"
$url = "https://www.strava.com/oauth/authorize?client_id=$($env:STRAVA_CLIENT_ID)&redirect_uri=$redirEnc&response_type=code&scope=$scope&approval_prompt=force"

# √Öpne i standard nettleser
Start-Process $url

# Vis URL i terminalen (i tilfelle du trenger √• kopiere den manuelt)
Write-Host "`n√Öpner autoriseringslenke i nettleser:"
Write-Host $url
üîÑ Deretter:
Strava √•pnes i nettleseren ‚Äî klikk ‚ÄúAuthorize‚Äù.

Du blir sendt til http://127.0.0.1:5179/api/debug/oauth_capture?...code=XXXXXX....

Kopier verdien av code= fra adressefeltet (f.eks. ffcb62823132e6505e43d76d4940759d54cad436).

N√•r du har koden, kan du bruke denne for √• f√• nye tokens:

powershell
Kopier kode
$code = "<lim inn koden her>"
$body = @{
  client_id     = $env:STRAVA_CLIENT_ID
  client_secret = "90845b55b04d073a1568465ac1e0ca55da269c82"
  code          = $code
  grant_type    = "authorization_code"
}
$res = Invoke-RestMethod -Method Post -Uri "https://www.strava.com/oauth/token" -Body $body
$res | Select-Object access_token, refresh_token, expires_at
# √Öpner authorize-URL ‚Üí lim inn code ‚Üí oppdaterer .env automatisk
powershell -NoProfile -ExecutionPolicy Bypass -File .\scripts\tools\strava_reauth.ps1

üìÑ HJELPEDOK: Start, analyse, publish + feils√∏k
1) Start API

Anbefalt: scripts\tools\start_api.ps1 (nytt, bedre logging), eller din start-api-no-reload.ps1.

Starter Uvicorn p√• √∏nsket port og viser full traceback hvis noe feiler.

Test at det kj√∏rer:

Invoke-RestMethod http://127.0.0.1:5179/api/health
Invoke-RestMethod http://127.0.0.1:5179/api/debug/token_present


Forvent ok:true p√• begge.

2) Analyze (valgfritt) og Publish

publish_ride.ps1 kan kj√∏re analyze f√∏rst (flagget -AnalyzeFirst) og deretter publish.

Viser HTTP-koder og JSON-body (PS 5.1-kompatibelt).

Dumper ogs√• n√∏kkelfelt fra data/sessions/<id>.json.

3) Token-h√•ndtering (engang/utl√∏p)

strava_reauth.ps1 √•pner Strava-authorize, du limer inn code fra URL, scriptet:

bytter code ‚Üí tokens

oppdaterer .env (STRAVA_ACCESS_TOKEN, STRAVA_REFRESH_TOKEN, STRAVA_TOKEN_EXPIRES_AT)

viser lokal utl√∏pstid

Hvor ofte? Access-token ‚âà 6 timer. Refresh-token varer lenge. Kj√∏r strava_reauth.ps1 n√•r du f√•r 401 eller du vil rotere tokens.

üßØ VANLIGE FEIL ‚Üí L√òSNING
Symptom	√Örsak	Fiks
{"detail":"Missing STRAVA_ACCESS_TOKEN"} / has_token=False	Server startet uten √• lese ny .env	Stopp server (Ctrl+C), start fra repo-roten, s√∏rg for load_dotenv(override=True) helt √∏verst i app.py.
401 Unauthorized ved token-exchange	Bruker gammel/allerede brukt code eller feil client-verdier	Kj√∏r strava_reauth.ps1 p√• nytt, lim inn fersk code, sjekk at STRAVA_CLIENT_ID/SECRET er riktige.
404 etter ‚ÄúAuthorize‚Äù	Mangler callback-rute, eller feil path	Det er OK n√•r du bruker manuell code. (Evt. legg til /api/debug/oauth_capture i app.py om du vil unng√• 404.)
Port hopper til 5180 / ‚Äúin use‚Äù	Noe lytter p√• 5179	`netstat -ano
Tom respons i PowerShell	Endpoint returnerer 204 / body ikke skrevet	Bruk publish_ride.ps1 (viser alt) eller endre endpoint til √• returnere JSON.
PS7-parametre funker ikke	Du kj√∏rer Windows PowerShell 5.1	Scriptene under er PS 5.1-kompatible (ingen -StatusCodeVariable).
SyntaxError: from __future__	Future-import ikke √∏verst	Flytt from __future__ import annotations helt √∏verst i app.py.