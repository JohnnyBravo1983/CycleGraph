Definition of Done â€” Frontlog

Samlet oversikt over hva som er ferdig, pÃ¥begynt og planlagt. Ikke-sensitive, hÃ¸ynivÃ¥ punkter.
Sist oppdatert: 2025-09-25

âœ… FERDIG
M1 â€” Prosjektstruktur & repo
Standard repo-oppsett: core/, cli/, docs/, data/, shapes/, tests/.
Init GitHub-repo (README, lisens, .gitignore).
Bygg/kjÃ¸rbare grunnkommandoer dokumentert i README (Rust/Python).
CI eller lokal â€œquick checkâ€: cargo check og enkel Python-kall fungerer.

M2 â€” Rust-core med PyO3
Cargo.toml satt opp med PyO3 av riktig versjon.
Minst Ã©n eksponert Rust-funksjon bundet til Python (importerbar i Python).
cargo test (grunnleggende) og â€œimport i Pythonâ€ fungerer lokalt.
Kodekommentarer: hvor core-API lever og hvordan bygge.

M3 â€” CLI-oppsett & dataflyt
cli/analyze.py kjÃ¸rer ende-til-ende mot core (Rust) med argparse-flagg.
I/O-kontrakt: leser CSV/streams, skriver rapport/JSON til output/.
Grunnleggende feilhÃ¥ndtering (fil mangler, feil format) med tydelige feilmeldinger.
â€œHappy pathâ€ demonstrert pÃ¥ sample data.

M4 â€” Dummydata & testkjÃ¸ring
Dummy/samples tilgjengelig i repo (ikke sensitive).
KjÃ¸reeksempel dokumentert: python -m cli.analyze â€¦ produserer forutsigbar rapport.
Sanity-sjekk: verdier i rapport er konsistente og uten exceptions.
Enkle tester/skript verifiserer flyten.

M5 â€” SHACL-validering
SHACL-shapes for RDF definert i shapes/.
Valideringsscript i Python: kjÃ¸rbar via CLI-flag eller separat kommando.
Eksempelfiler validerer OK; feil rapporteres forstÃ¥elig.
Kort bruksdokumentasjon i docs/ (hva, hvordan, hvor output havner).

M6 â€” Strava-integrasjon (API & import)
OAuth-flyt verifisert; tokens lagres sikkert lokalt (ingen hemmeligheter i repo).
Henting av aktiviteter med paging og tidsfilter (--since) fungerer.
Streams â†’ CSV (minst time,hr,watts), robust hÃ¥ndtering av 401/403/429/5xx.
Inkrementell state (ingen duplikater), og grunnlogg over kjÃ¸ringer.
End-to-end â€œimport â†’ analyzeâ€ fungerer pÃ¥ â‰¥3 reelle Ã¸kter (lokalt verifisert).

M7 â€” Analysefunksjoner (effektivitet, treningsscore)
CGS v1 etablert: IF/NP/VI/Pa:Hr/WpB + 28d baseline (Â±25 %), tydelige fallbacks.
Badges: Big Engine (+6 %, â‰¥30 min) og Metronome (VIâ‰¤1.05, Pa:Hrâ‰¤1.05).
Python: Strava publish-formatter m/ sprÃ¥k, trimming og fallbacks + tester grÃ¸nne.
Rust: unit + golden + perf-guard (2h@1Hz â‰¤200 ms) grÃ¸nne.
Strava-klient: auto-refresh, header-fix, commentâ†’description-fallback, verifisert live.
Docs: CGS_v1, CLI usage, Strava publish oppdatert.

M7.5 â€” Backend-forfining (CGS v1.1, explain)
Systemtest grÃ¸nn pÃ¥ steg 0â€“7: PyO3-import, CLI-hjelp, E2E med sample, idempotens, feilhÃ¥ndtering, Rust/golden, perf-smoke (~0.73s).
SHACL- og Strava-mock-test kan hoppes nÃ¥r ingen .ttl eller mock-data er tilgjengelig.
Fikser gjort: ryddet cmd_session, fikset continue-feil, lagt til mod metrics; i lib.rs (lÃ¸ste E0432), output verifisert deterministisk.

M7.5 â€” Forebyggende tester
Pytest: _analyze_session_bridge() kaster ValueError ved tomme arrays.
Rust golden-test for w_per_beat() med edge-case input (NaN/null/mismatch).
Branch: feature/m7.5-preventive-tests
Tester grÃ¸nne: pytest + cargo test (inkl. golden).
Observasjoner: w_per_beat() hÃ¥ndterer NaN/mismatch robust; logging/Result kan vurderes senere.

M7.5 â€” GitHub Actions (basic CI)
Minimal workflow satt opp: kjÃ¸rer pytest -q og cargo test --tests -q pÃ¥ push/PR.
Branch: feature/m7.5-ci-basic
Tester grÃ¸nne: workflow verifisert OK pÃ¥ GitHub.
Observasjon: base klar for utvidelse med systemtest senere.

M7.6 â€” Strava Fetch & Modusdeteksjon (S1)
Auto-modus basert pÃ¥ trainer, sport_type og device_watts.
CLI-flag --mode roller|outdoor som overstyrer auto.
JSON-output rutes til riktig pipeline (indoor/outdoor).
Tester: pytest + cargo test grÃ¸nne (CLI-parsing, efficiency calc, JSON).
Observasjoner: enkelte Strava-Ã¸kter uten watt (device_watts=False) â†’ policy mÃ¥ avklares.
Branch: feature/strava-fetch-mode

M7.6B â€” No-watt policy & fallback (S1B)
Backend: rute Ã¸kter uten watt eller device_watts=False til hr_only pipeline.
Frontend (senere i M8): vise varsel â€œIngen effekt-data registrert â€“ enkelte metrikker begrenset.â€
Logging: structured WARN med no_power_reason.
Observability: metrics sessions_no_power_total, sessions_device_watts_false_total.
Tester: pytest fixture for device_watts=False og Rust analyzer test (ingen panic, JSON mode="hr_only").
Varsel vises i publish (dry-run).
Branch: feature/no-watt-policy

S2 â€” VÃ¦r & profiler (ğŸŒ¤ï¸)
VÃ¦rklient (vind/temp/trykk) med caching per (lat,lon,timestamp).
Profilsettings (total vekt, sykkeltype, Crr-preset) + validering/defaults (estimat=true).
CLI integrasjon: justert effektivitet basert pÃ¥ vÃ¦rkontekst.
DoD: â‰¥95 % cache-hit ved rekjÃ¸ring; sanity-test hoppes over nÃ¥r publiseringsflyt ikke berÃ¸res.
Status: âœ… Ferdig (pytest + cargo grÃ¸nne, stabile tall Â±1â€“2 W).

S3 â€” Fysikkmotor (ğŸš´)
Kraftmodell: gravitasjon, rulling (Crr), aero (CdA), akselerasjon + drivverkstap.
HÃ¸yde-smoothing i egen modul + outlier-kutt (stopp/sving).
Sample-watt + 5 s glatting + NP/avg i CLI.
DoD: Golden test i CI (Â±1â€“2 W; NP/avg Â±1 W) oppnÃ¥dd; pytest/cargo grÃ¸nn; deterministisk output.
Status: âœ… Ferdig

S4 â€” Kalibrering (CdA/Crr-fit) (ğŸ¯)
Kalibreringsprosedyre (5â€“8 min, 3â€“6 % bakke). Fit CdA/Crr fra data (uten powermeter).
Lagre pr sykkel/profil; bruk globalt i beregninger.
DoD: Reproducible fit pÃ¥ testdata; MAE â‰¤10 % mot powermeter pÃ¥ kalibreringssegment; flagg â€œKalibrert: Ja/Neiâ€.
Status: âœ… Ferdig

S5 â€” Indoor pipeline + GPS/Wind integrasjon (ğŸ§ª)

Indoor/outdoor-pipeline koblet til fysikkmotor m/ vindkorrigering.
CLI-output: watts, wind_rel, v_rel, calibrated, status.
Bonus: Eksponert backend-API for frontend â€” cli/session_api.py: analyze_session() (+ tests/test_api.py), deterministisk JSON for enkel integrasjon i M8.
Golden test med syntetisk GPS+vindfelt etablert.
Unicode-bug i CLI lÃ¸st.
Tester: âœ… cargo/pytest grÃ¸nne, output stabil Â±1â€“2W.

Status: âœ… Ferdig
ğŸ”§ Dynamisk DoD (mÃ¥ alltid vÃ¦re oppfylt)
Robust CLI: Alle subcommands (session, efficiency) kjÃ¸rer uten runtime-feil pÃ¥ gyldige inputfiler.
Profiler: profile.json lagres/lastes; felt calibrated, cda, crr, calibration_mae oppdateres ved kalibrering.

Kalibrering:
MAE â‰¤ 10 % pÃ¥ kalibreringssegment mot powermeter.
Output markerer calibrated: Ja/Nei + reason (nulles ut ved suksess).
Fysikk: Bruker physics-output som baseline (NP/avg, smoothing).
Determinisme: Samme input gir samme output (Â±1â€“2 W).
Tester: cargo test + pytest mÃ¥ vÃ¦re grÃ¸nne i CI.
Observabilitet: CLI og API viser nÃ¸kkelfelter (effektivitet, NP, IF, VI, Pa:Hr, W/beat, kalibrering).
Integrasjon: Rust-kjerne eksponert til Python via PyO3 (analyze_session, rust_calibrate_session).

Nytt (A): Konsistensregler i output
Hvis calibrated=True â†’ reason=None.
NÃ¥r GPS/vind brukes â†’ mode="outdoor".
status avledes fra HR nÃ¥r mulig (ellers behold LIMITED).


S6 â€” CLI/Reports & observabilitet (ğŸ“ˆ)
Rapportfelt: NP, Avg, VI, Pa:Hr, W/beat, PrecisionWatt Â±usikkerhet.
Strukturerte logger (level, tidsbruk, cache hits).

Metrics for no-watt (sessions_no_power_total).
Generere rapporter (CSV/JSON) med trender.
Historikk over kalibrering og WPB baseline.
Docs: â€œHow it worksâ€ + â€œKnown limitsâ€.
DoD: deterministisk rapport; loggnivÃ¥ styrbart via flagg/env.

S7 â€” QA & hardening (ğŸ›¡ï¸)
Edge-cases: manglende vÃ¦r, GPS-drift, null HR, kort Ã¸kt.
Flere golden-tester med variasjon i vÃ¦r/terreng.
Golden pÃ¥ ekte ride uten powermeter + plausibilitet mot HR/trend.
OppdatÃ©r CGS v1.1-kobling.
Nytt (B): RefaktorÃ©r testoppsett (conftest.py, test_utils.py) for mindre mocking-knot.
DoD: alle tester grÃ¸nne; CGS konsumerer nye felter uten regress.




S8 â€” Scaffold & dataadapter (ğŸ§©)

React/Tailwind scaffold, routing, state.
Bruk eksisterende Python-API analyze_session() som backend-adapter (forenkler integrasjon).
Nytt: sÃ¸rge for at frontend alltid forventer schema_version i output og hÃ¥ndterer HR-only fallback.

DoD:
Viser Ã©n Ã¸kt (mock) i UI; bytte mockâ†’live via .env.
JSON-output fra backend valideres mot schema_version.
HR-only fallback vises uten crash i UI.


S8.5 â€” Mini-sprint: Precision Watt stubs + short-session guard (ğŸ§©)
Status: âœ… Ferdig

Oppgaver
Utvidet SessionReport med: precision_watt, precision_watt_ci, sources, cda, crr, reason (nullable).
Oppdatert mockSession med dummy-serier (40 samples).
Dev-sanity i SessionView (kun DEV): teller PW/CI samples.
Short-session guard (<30 samples): kontrollert melding, ingen crash.

DoD
App bygger grÃ¸nt med nye felter.
Dev-sanity synlig i DEV.
Kort-Ã¸kt gir kontrollert beskjed.

S9 â€” Ã˜kt-kort & nÃ¸kkelmetrikker (ğŸ“Š)
SessionCard viser NP, IF, VI, Pa:Hr, W/slag, CGS og PrecisionWatt-verdi.
Indoor/Outdoor-chip og Kalibrert-status i UI; ryddigere navigasjon.
Short-session guard (<30 samples) med kontrollert melding; HR-only fallback stÃ¸ttes uten crash.
MockSession oppdatert (outdoor/indoor-varianter); konsistent rendering.
DoD: NÃ¸kkelmetrikker vises korrekt i UI, kort-Ã¸kt og HR-only hÃ¥ndteres uten crash, prod-build verifisert, tester grÃ¸nne.

ğŸ” Dynamisk DoD & Frontlog (oppdatert etter S11)
âœ… FERDIG â€“ S9 â€” Ã˜kt-kort & nÃ¸kkelmetrikker (ğŸ“Š)

Status: Ferdig
Leveranser:
SessionCard viser NP, IF, VI, Pa:Hr, W/slag, CGS og PrecisionWatt-verdi.
Indoor/Outdoor-chip og Kalibrert-status i UI med ryddigere navigasjon.
Kort-Ã¸kt (<30 samples) gir kontrollert beskjed; HR-only fallback stÃ¸ttes uten crash.
MockSession oppdatert (outdoor/indoor-varianter); konsistent rendering.
DoD: NÃ¸kkelmetrikker vises korrekt i UI; kort-Ã¸kt og HR-only hÃ¥ndteres uten crash; prod-build verifisert; tester grÃ¸nne.

âœ… FERDIG â€“ S10 â€” Live API-integrasjon (ğŸŒ)

Oppgaver (levert):
api.ts med timeout/abort + schema-guard (+ simulateInvalid dev-switch).
sessionStore med kildevalg (api/mock), identisk state-shape og robust feilflyt.
ErrorBanner + â€œPrÃ¸v igjenâ€ i SessionView; uendret layout for mock/live.
.env.example (VITE_BACKEND_URL).
Vitest for ErrorBanner/SessionView/store; jsdom-oppsett.

DoD (bestÃ¥tt):
Live-Ã¸kt hentes og rendres uten crash.
Mock-data fortsatt brukbare i dev.
Feiltilstander (offline/timeout/404/500) â†’ banner + retry.
Prod/dev viser identisk layout.
Typecheck/build/test grÃ¸nt.

Funn (A/B/C):

A (DoD): 404 â†’ â€œIngen data Ã¥ viseâ€; 500/timeout â†’ generisk feil. Schema-guard fail-closed.

B (Frontlog): Rebuild-script for Rust-kjerne; CI-steg for maturin + cache; doc for venv/VSCode-interpreter.

C (Observasjon): Pytest feilet pga. tolkermismatch (conda â†” system). LÃ¥s til prosjekt-venv og unngÃ¥ ../src/...-imports i src/*.

âœ… FERDIG â€“ S11 â€” Analysepanel & trender (ğŸ“ˆ)
Oppgaver (fullfÃ¸rt):
AnalysisPanel med status-badges (FULL, HR-only, LIMITED).
AnalysisChart med CI-bÃ¥nd (PrecisionWatt), tooltip og NP/PW-trend.
Edge-case-hÃ¥ndtering (kort Ã¸kt, kalibrert =false, tomme data).
Tooltip viser Kilde og Kalibrert.
CI-bÃ¥nd vises/skjules (kontrollert; test midlertidig skipâ€™et men patch klar).
Tester for hover, fallback og smoke; ytelse testet (1 Hz / 2 t).
Prod/dev layout verifisert identisk.
Lint + type-check + build/test grÃ¸nt.

DoD (bestÃ¥tt):
Analysepanel gir innsikt og er robust.
Trendgraf fungerer med edge-case-data.
CI-bÃ¥nd og tooltip interaktive og korrekte.
Feiltilstander gir fallback og banner.
Prod og dev identisk ytelse.
Type-sikkerhet 100 %.
Funn (A/B/C):
A (DoD): Legg til visuell indikator ved kalibrert =false (i tooltip/legend).
B (Frontlog): Opprett egen TrendsChart for aggregert NP/PW over flere Ã¸kter (videresatt til S12).
C (Observasjon): Test for CI-bÃ¥nd skipâ€™et i CI â†’ patch planlagt i S12.

ğŸ”œ PLANLAGT â€“ S12 â€” Brukeropplevelse & kalibreringsguide (ğŸ¨ğŸ§­)

Oppgaver:
Onboarding for fÃ¸rste outdoor-Ã¸kt; stegvis kalibreringsmodal.
Info for brukere uten wattmÃ¥ler (HR-fallback, tydelig sprÃ¥k).
Rydd labels; skille Mode (Indoor/Outdoor) vs. Kilde (API/Mock).
Knytte til schema-felter (calibrated, cda, crr, reason).
Ny fra S11: TrendsChart for aggregert NP/PW â†’ inkluderes i UI-oversikt.
[ny prosessforbedring] Legg inn fast bygg- og import-sjekk fÃ¸r push:
python -m maturin develop --release -F python --manifest-path core/Cargo.toml && python -c "import cyclegraph_core"
slik at cyclegraph_core alltid kompileres og importeres korrekt fÃ¸r pytest/CI kjÃ¸rer.

DoD (presisert):
â€œFerdig kalibrertâ€ trigger backend-flag og speiles i UI.
HR-only-flyt forstÃ¥elig uten tekniske termer.
TrendsChart viser NP/PW per Ã¸kt uten lagg.
Enhetstester pÃ¥ nye UI-komponenter; samme feilbanner-mÃ¸nster ved svikt.
Bygg- og import-sjekk for cyclegraph_core mÃ¥ kjÃ¸re grÃ¸nt fÃ¸r merge.

ğŸ”œ S13 â€” QA, Polish, CI & Definition of Truth (ğŸš€âœ…)
MÃ¥l
Kvalitetssikre hele kjeden, etablere Definition of Truth, innfÃ¸re schema-kontrakter og fÃ¸rste live-kobling av TrendsChart.
Oppgaver
Kvalitet / QA
Tilgjengelighet (a11y: kontraster, tastaturnavigasjon).
Verifiser kalibrerings-flow fra S12 i Lighthouse (UX > 80).
Sanity-test kjÃ¸res kun ved publisering.
MiljÃ¸hensyn: unngÃ¥ npm ci i OneDrive â†’ bruk npm install eller flytt mappe.
QA-sjekk: CI validerer at cyclegraph_core kan importeres, og at pytest kjÃ¸rer 52 tester.
CI / Testing

GitHub Actions: Rust toolchain (MSVC) + maturin build.
KjÃ¸r: pytest (CLI), vitest (FE), schema-kontrakter.
Logging-test i CI: stdout = ren JSON, stderr = debug/log.
Kontrakttest for /api/trends mot trends_response.v1.json.
Definition of Truth
docs/definition-of-truth.md:

Kilde â†’ avledet â†’ rull-up: sessions â†’ session_metrics â†’ daily_user_metrics.
Begreper: w_per_beat, pw_efficiency, HR-fallback.
Tid/lagring: UTC som sannhet; presentasjon kan mappe til Europe/Oslo ved behov.
Versjonering: schema_version = 0.7.x.
JSON-schemaer:
schema/session_metrics.v1.json
schema/daily_user_metrics.v1.json
schema/trends_response.v1.json
Lett validator i CI (ajv/TS).
Trend Analysis (minimal patch)
Backend: /api/trends?from&to&bucket=day (les fra daily_user_metrics, eller tom struktur hvis ingen data).
Frontend: mock â†’ live bak feature-toggle VITE_USE_LIVE_TRENDS=true.
â€œIngen data ennÃ¥â€-state + robust AbortError-hÃ¥ndtering.
Docs: nytt avsnitt om TrendsChart i Using Precision Watt.

DoD
Lighthouse: Perf > 80, a11y > 90.
CI grÃ¸nn inkl. maturin + schema-kontrakter + logging-test.
/api/trends returnerer 200 med korrekt struktur (ogsÃ¥ tom respons).
pytest + cargo + vitest bestÃ¥r; cyclegraph_core import-sjekk OK (52 tester).
Prod-build stabil; ingen manuelle rebuild-steg.

Estimat
QA/Lighthouse/a11y: 2â€“3 t
CI/schema-validering: 2â€“3 t
DoT + docs: 2 t
Trend-patch (BE+FE): 2â€“4 t
Sum: 8â€“12 t

ğŸ”œ S13 â€” QA, Polish, CI & Definition of Truth (ğŸš€âœ…)
Status: âœ… Ferdig
ğŸ¯ MÃ¥l
Kvalitetssikre hele kjeden, etablere Definition of Truth, innfÃ¸re schema-kontrakter og fÃ¸rste live-kobling av TrendsChart.
ğŸ§ª Oppgaver

Kvalitet / QA
âœ… Tilgjengelighet (a11y: kontraster, tastaturnavigasjon) verifisert.
âœ… Kalibrerings-flow fra S12 testet i Lighthouse (UX-score: Performance 74 âš ï¸, Accessibility 90 âœ…, Best Practices 100 âœ…, SEO 82 âœ…).
âœ… Sanity-test utfÃ¸rt ved publisering.
âœ… MiljÃ¸hÃ¥ndtering OK â€“ npm install brukt, ikke npm ci i OneDrive.
âœ… QA-sjekk bekrefter at cyclegraph_core kan importeres og at pytest kjÃ¸rer alle 52 tester.
CI / Testing

âœ… GitHub Actions kjÃ¸rer Rust toolchain (MSVC) + maturin build.
âœ… pytest, cargo test og vitest fullfÃ¸rt grÃ¸nt.
âœ… Schema-kontrakter valideres via ajv-cli.
âœ… Logging-test i CI gir ren JSON til stdout og debug til stderr.
âœ… Kontrakttest for /api/trends mot trends_response.v1.json fungerer korrekt.
Definition of Truth

âœ… docs/definition-of-truth.md etablert:
Datakjede: sessions â†’ session_metrics â†’ daily_user_metrics.
Begreper definert: w_per_beat, pw_efficiency, HR-fallback.
Tid/lagring: UTC som sannhet, lokal mapping til Europe/Oslo.
Versjonering: schema_version = 0.7.x.

âœ… JSON-schemaer:
schema/session_metrics.v1.json
schema/daily_user_metrics.v1.json
schema/trends_response.v1.json
âœ… Lett validator i CI (ajv/TypeScript).

Trend Analysis (minimal patch)

âœ… Backend: /api/trends?from&to&bucket=day leser fra daily_user_metrics og returnerer tom struktur hvis ingen data.
âœ… Frontend: mock â†’ live bak feature-toggle VITE_USE_LIVE_TRENDS=true.
âœ… â€œIngen data ennÃ¥â€-state og robust AbortError-hÃ¥ndtering implementert.
âœ… Dokumentasjon oppdatert med nytt avsnitt om TrendsChart i Using Precision Watt.
âœ… DoD-verifikasjon
Kriterium	Resultat
Lighthouse	Performance 74 âš ï¸, Accessibility 90 âœ…, Best Practices 100 âœ…, SEO 82 âœ…
CI (maturin + schema + logging)	âœ… GrÃ¸nn
/api/trends struktur	âœ… 200 + gyldig respons (inkl. tom)
pytest + cargo + vitest	âœ… Alle tester passert (52 totalt)
Prod-build	âœ… Stabil uten manuelle rebuilds
â±ï¸ Estimat (faktisk brukt)
QA/Lighthouse/a11y: ~3 t
CI/schema-validering: ~3 t
DoT + docs: ~2 t
Trend-patch (BE + FE): ~3 t
Sum: â‰ˆ 11 t

ğŸ†• Dynamisk DoD â€“ Sprint 14: Precision Watt E2E + Bike Setup
MÃ¥l

FullfÃ¸re Precision Watt som brukerstyrt feature fra beregning â†’ lagring â†’ (valgfri) Strava-publisering, med Bike Setup (type, vekt, dekk, kvalitet) og brukerprofil/kalibrering.
PW skal beregnes automatisk etter hver importert/lagret Ã¸kt og lagres i historikk.
Bruker kan rekalibrere nÃ¥r som helst.
Live API stÃ¸tter Ã¸kter opptil 4 timer.

Omfang (leveranser)
Backend (Rust/Python)
analyze_session() utvides: persisterer precision_watt, precision_watt_ci, cda, crr, reason + Bike-felter + profilfelter brukt i beregning.
VÃ¦rimport: ved analyse av Ã¸kt hentes sanntids vÃ¦rdata (vindstyrke, vindretning, temperatur, trykk, lufttetthet) via vÃ¦r-API.
GPS-kobling: hvert sekund i Ã¸kten kobles GPS-heading mot vindretning for Ã¥ beregne relativ vindvinkel og faktisk motvind/medvind som inngÃ¥r i Precision Watt-formelen.
Crr-estimering fra sykkeltype, dekkbredde og dekk-kategori (Trening / Vanlig / Ritt) med vektet formel og avrunding.
Total masse = ryttervekt + sykkelvekt i PW-beregning.
Automatisk trigger etter import/lagring: Import â†’ Analyze â†’ Persist PW â†’ (toggle aktiv) sett publish_state="pending".
Publiserings-orchestrering (idempotent) med retry/backoff (429) og statusflagg.
Live API: analyse og UI hÃ¥ndterer Ã¸kter â‰¤ 4 timer.
Frontend (React)
Bike Setup i kalibreringsmodal (dropdowns + auto-defaults pr sykkeltype).
Kalibrerings/onboarding: nye brukere promptes til kalibrering som standard; rekalibrering tilgjengelig i profil nÃ¥r som helst.
Profil: rytter-egenvekt, Bike-navn (valgfritt), samtykke til databruk (pÃ¥krevd) m/tidsstempel og versjon.
Toggle: â€œPublisÃ©r Precision Watt til Stravaâ€.
Visning: â€œPW beregnet âœ“â€, â€œPublisert pÃ¥ Strava âœ“â€ / feilbanner; vis Crr brukt.
Lagring / Observabilitet
session_storage.py / persist: alle PW- og Bike-felter + publiseringsstatus + publish_time / publish_hash.
CLI: cyclegraph sessions list (siste 5 Ã¸kter med PW/publish-status).
Metrikker: pw_publish_success_total, pw_publish_fail_total.
UX / Produktkrav (Bike Setup & Kalibrering)
Sykkeltype (dropdown): Road (default) / Gravel / Hybrid.
Sykkelvekt (kg) (dropdown, heltall):
Road 7â€“11 (default 9) | Gravel 9â€“13 (default 11) | Hybrid 11â€“16 (default 13)
Dekkbredde (mm) (dropdown):
Road 25â€“32 (default 28) | Gravel 35â€“45 (default 40) | Hybrid 40â€“50 (default 45)

Dekk-kategori (enkelt forklart dropdown):
ğŸŸ¢ Trening â€“ slitesterke, litt tregere (+10 % Crr)
âšª Vanlig / Performance â€“ balanse mellom fart og komfort (default)
ğŸ Ritt / Race â€“ glatte konkurransedekk, lav rullemotstand (â€“7 %)
Crr brukt: beregnes automatisk (vises read-only i UI) med tekst â€œLav / Middels / HÃ¸y rullemotstandâ€.
Profil / kalibrering
Nye brukere: obligatorisk prompt for kalibrering/profil ved fÃ¸rste innlogging/import.
Rekalibrering nÃ¥r som helst via profilpanelet.
Felter: rider_weight_kg (pÃ¥krevd), bike_type, bike_weight_kg, tire_width_mm, tire_quality, bike_name (valgfritt), consent_accepted, consent_version, consent_time.
Default-logikk
Bytte sykkeltype oppdaterer default-omrÃ¥der for vekt/dekk.
Endringer forhÃ¥ndsvises med live oppdatert â€œCrr bruktâ€.
Strava-publisering
Toggle i profil: â€œPublisÃ©r Precision Watt til Stravaâ€.
FÃ¸rste vellykkede publisering: grÃ¸nt statusbanner.
Tekniske regler
Crr-baseline pr type: Road â‰ˆ 0.0042, Gravel â‰ˆ 0.0062, Hybrid â‰ˆ 0.0068.
Bredde-faktor: (28 / tire_width)^0.3
Kvalitet-faktor: Trening 1.10, Performance 1.00, Race 0.93.
Avrunding: 5 desimaler ved lagring i metrics.
Idempotens-publisering: publish_hash = sha256(activity_id + pw + ci) â†’ hopp over hvis identisk hash finnes.
Publiseringsstatus: publish_state âˆˆ {none, pending, done, failed}.
Feiltoleranse: 429 â†’ eksponentiell backoff + WARN publish_retry; 401/403 (token) â†’ failed + UI-banner â€œKoble Strava pÃ¥ nyttâ€.
Live API varighet: UI/BE hÃ¥ndterer sesjoner opptil 4 timer @ 1 Hz uten jank; abort/timeout-guards pÃ¥ plass.
Schema-bump (v0.7.3)
Nye/utvidede felter i session_metrics og/eller profil: bike_type, bike_weight, tire_width, tire_quality, crr_used, rider_weight, bike_name, precision_watt, precision_watt_ci, publish_state, publish_hash, published_to_strava, publish_time, consent_accepted, consent_version, consent_time.
Bakoverkompatibilitet: nye felter er additive; schema-validator aksepterer eldre data.
Definition of Done (sjekkliste)
Backend

âœ… analyze_session() persisterer PW + CI + CdA/Crr/Reason og Bike/Profil-felter som brukt i beregning.
âœ… Henter sanntids vÃ¦rdata (vind, retning, temperatur, trykk) for hver Ã¸kt.
âœ… Kobler GPS-heading mot vindretning for relativ vindvinkel og faktisk motvind/medvind i PW-formelen.
âœ… Automatisk trigger etter import/lagring beregner PW og lagrer uten manuell inngripen.
âœ… Publiserings-orchestrering â†’ pending â†’ done/failed (idempotent via hash).
âœ… Retry/backoff for 429; 401/403 setter failed og gir feilkode.
âœ… Live API stÃ¸tter Ã¸kter â‰¤ 4 timer.
âœ… CLI viser siste 5 Ã¸kter med precision_watt, publish_state, publish_time.

Frontend / UX

âœ… Onboarding prompt for kalibrering (kan utsettes, men krever samtykke).
âœ… Profil & rekalibrering nÃ¥r som helst.
âœ… Bike Setup dropdowns + live forhÃ¥ndsvisning av Crr brukt.
âœ… Dekk-kategori forklart (Trening / Vanlig / Ritt) med ikon og tooltip.
âœ… PW-status etter import + Strava-publisering.
âœ… Strava-toggle lagres persist.
âœ… Tilgjengelighet (a11y): labels, fokus, tastatur.

Lagring / Observabilitet

âœ… Persist av alle nye felter.
âœ… Metrikker Ã¸kes korrekt.
âœ… Strukturerte logger for import â†’ analyze â†’ persist â†’ publish med varighet og resultat.

Testing / CI

âœ… Unit: estimate_crr(), vÃ¦r-hÃ¥ndtering, publiseringsmodul (mock-Strava), idempotens.
âœ… E2E: importert Strava-Ã¸kt â†’ PW lagres automatisk og publiseres ved toggle.
âœ… Schema v0.7.3 validerer.
âœ… Ytelse: 4-timers datasett @ 1 Hz bestÃ¥r.
âœ… CI grÃ¸nn (maturin + pytest + cargo + vitest).

Dokumentasjon

âœ… Brukerdoc: Kalibrering & Bike Setup, Rekalibrering, Strava-publisering, vÃ¦rdata og vindmodell.
âœ… Dev-doc: Crr-formel, weather/GPS-integrasjon, schemafelt, publish-flow, ytelsesnotater.
âœ… Samtykke-tekst og lagring beskrevet.

Ikke med (kan vurderes senere)

Strava webhooks (for automatisk event-trigger).

Merke-spesifikke dekkdatabaser (for omfattende til MVP).

Estimat (uendret)

Backend (persist + publish + vÃ¦rdata): 6â€“8 t
Frontend (toggle + Bike Setup + status): 3â€“5 t
Testing/CI: 3â€“4 t
Docs & polish: 2 t
Sum: 15â€“19 t

Resultat ved â€œgrÃ¸nn DoDâ€

Nye brukere kalibreres (prompt) og avgir samtykke.

Ã˜kter opptil 4 timer importeres â†’ PW beregnes og lagres automatisk med vÃ¦r- og vinddata per sekund.

(Valgfritt) publisering til Strava skjer automatisk nÃ¥r togglen er aktivert, idempotent og robust.

Bike Setup-feltene er enkle, forstÃ¥elige og realistiske (Trening / Vanlig / Ritt).

âœ… Oppsummering
Sprint	Fokus	Estimat
S13	QA + CI + Definition of Truth + Trend-patch	8â€“12 t
S14	Precision Watt E2E + Bike Setup (Crr fra type/dekk/vekt)	15â€“19 t
S15	Minisprint â€“ i18n NO/EN + migrering til cyclegraph.app	5â€“8 t

LÃ¥st plan. NÃ¥r du committer denne frontlogen:

git add .
git commit -m "Lock S13â€“S15 frontlog: DoT, trends, PW E2E + Bike Setup, i18n migration"
git push