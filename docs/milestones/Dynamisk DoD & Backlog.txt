Definition of Done â€” Frontlog

Samlet oversikt over hva som er ferdig, pÃ¥begynt og planlagt. Ikke-sensitive, hÃ¸ynivÃ¥ punkter.
Sist oppdatert: 2025-09-25

âœ… FERDIG
M1 â€” Prosjektstruktur & repo
Standard repo-oppsett: core/, cli/, docs/, data/, shapes/, tests/.
Init GitHub-repo (README, lisens, .gitignore).
Bygg/kjÃ¸rbare grunnkommandoer dokumentert i README (Rust/Python).
CI eller lokal â€œquick checkâ€: cargo check og enkel Python-kall fungerer.

M2 â€” Rust-core med PyO3
Cargo.toml satt opp med PyO3 av riktig versjon.
Minst Ã©n eksponert Rust-funksjon bundet til Python (importerbar i Python).
cargo test (grunnleggende) og â€œimport i Pythonâ€ fungerer lokalt.
Kodekommentarer: hvor core-API lever og hvordan bygge.

M3 â€” CLI-oppsett & dataflyt
cli/analyze.py kjÃ¸rer ende-til-ende mot core (Rust) med argparse-flagg.
I/O-kontrakt: leser CSV/streams, skriver rapport/JSON til output/.
Grunnleggende feilhÃ¥ndtering (fil mangler, feil format) med tydelige feilmeldinger.
â€œHappy pathâ€ demonstrert pÃ¥ sample data.

M4 â€” Dummydata & testkjÃ¸ring
Dummy/samples tilgjengelig i repo (ikke sensitive).
KjÃ¸reeksempel dokumentert: python -m cli.analyze â€¦ produserer forutsigbar rapport.
Sanity-sjekk: verdier i rapport er konsistente og uten exceptions.
Enkle tester/skript verifiserer flyten.

M5 â€” SHACL-validering
SHACL-shapes for RDF definert i shapes/.
Valideringsscript i Python: kjÃ¸rbar via CLI-flag eller separat kommando.
Eksempelfiler validerer OK; feil rapporteres forstÃ¥elig.
Kort bruksdokumentasjon i docs/ (hva, hvordan, hvor output havner).

M6 â€” Strava-integrasjon (API & import)
OAuth-flyt verifisert; tokens lagres sikkert lokalt (ingen hemmeligheter i repo).
Henting av aktiviteter med paging og tidsfilter (--since) fungerer.
Streams â†’ CSV (minst time,hr,watts), robust hÃ¥ndtering av 401/403/429/5xx.
Inkrementell state (ingen duplikater), og grunnlogg over kjÃ¸ringer.
End-to-end â€œimport â†’ analyzeâ€ fungerer pÃ¥ â‰¥3 reelle Ã¸kter (lokalt verifisert).

M7 â€” Analysefunksjoner (effektivitet, treningsscore)
CGS v1 etablert: IF/NP/VI/Pa:Hr/WpB + 28d baseline (Â±25 %), tydelige fallbacks.
Badges: Big Engine (+6 %, â‰¥30 min) og Metronome (VIâ‰¤1.05, Pa:Hrâ‰¤1.05).
Python: Strava publish-formatter m/ sprÃ¥k, trimming og fallbacks + tester grÃ¸nne.
Rust: unit + golden + perf-guard (2h@1Hz â‰¤200 ms) grÃ¸nne.
Strava-klient: auto-refresh, header-fix, commentâ†’description-fallback, verifisert live.
Docs: CGS_v1, CLI usage, Strava publish oppdatert.

M7.5 â€” Backend-forfining (CGS v1.1, explain)
Systemtest grÃ¸nn pÃ¥ steg 0â€“7: PyO3-import, CLI-hjelp, E2E med sample, idempotens, feilhÃ¥ndtering, Rust/golden, perf-smoke (~0.73s).
SHACL- og Strava-mock-test kan hoppes nÃ¥r ingen .ttl eller mock-data er tilgjengelig.
Fikser gjort: ryddet cmd_session, fikset continue-feil, lagt til mod metrics; i lib.rs (lÃ¸ste E0432), output verifisert deterministisk.

M7.5 â€” Forebyggende tester
Pytest: _analyze_session_bridge() kaster ValueError ved tomme arrays.
Rust golden-test for w_per_beat() med edge-case input (NaN/null/mismatch).
Branch: feature/m7.5-preventive-tests
Tester grÃ¸nne: pytest + cargo test (inkl. golden).
Observasjoner: w_per_beat() hÃ¥ndterer NaN/mismatch robust; logging/Result kan vurderes senere.

M7.5 â€” GitHub Actions (basic CI)
Minimal workflow satt opp: kjÃ¸rer pytest -q og cargo test --tests -q pÃ¥ push/PR.
Branch: feature/m7.5-ci-basic
Tester grÃ¸nne: workflow verifisert OK pÃ¥ GitHub.
Observasjon: base klar for utvidelse med systemtest senere.

M7.6 â€” Strava Fetch & Modusdeteksjon (S1)
Auto-modus basert pÃ¥ trainer, sport_type og device_watts.
CLI-flag --mode roller|outdoor som overstyrer auto.
JSON-output rutes til riktig pipeline (indoor/outdoor).
Tester: pytest + cargo test grÃ¸nne (CLI-parsing, efficiency calc, JSON).
Observasjoner: enkelte Strava-Ã¸kter uten watt (device_watts=False) â†’ policy mÃ¥ avklares.
Branch: feature/strava-fetch-mode

M7.6B â€” No-watt policy & fallback (S1B)
Backend: rute Ã¸kter uten watt eller device_watts=False til hr_only pipeline.
Frontend (senere i M8): vise varsel â€œIngen effekt-data registrert â€“ enkelte metrikker begrenset.â€
Logging: structured WARN med no_power_reason.
Observability: metrics sessions_no_power_total, sessions_device_watts_false_total.
Tester: pytest fixture for device_watts=False og Rust analyzer test (ingen panic, JSON mode="hr_only").
Varsel vises i publish (dry-run).
Branch: feature/no-watt-policy

S2 â€” VÃ¦r & profiler (ğŸŒ¤ï¸)
VÃ¦rklient (vind/temp/trykk) med caching per (lat,lon,timestamp).
Profilsettings (total vekt, sykkeltype, Crr-preset) + validering/defaults (estimat=true).
CLI integrasjon: justert effektivitet basert pÃ¥ vÃ¦rkontekst.
DoD: â‰¥95 % cache-hit ved rekjÃ¸ring; sanity-test hoppes over nÃ¥r publiseringsflyt ikke berÃ¸res.
Status: âœ… Ferdig (pytest + cargo grÃ¸nne, stabile tall Â±1â€“2 W).

S3 â€” Fysikkmotor (ğŸš´)
Kraftmodell: gravitasjon, rulling (Crr), aero (CdA), akselerasjon + drivverkstap.
HÃ¸yde-smoothing i egen modul + outlier-kutt (stopp/sving).
Sample-watt + 5 s glatting + NP/avg i CLI.
DoD: Golden test i CI (Â±1â€“2 W; NP/avg Â±1 W) oppnÃ¥dd; pytest/cargo grÃ¸nn; deterministisk output.
Status: âœ… Ferdig

S4 â€” Kalibrering (CdA/Crr-fit) (ğŸ¯)
Kalibreringsprosedyre (5â€“8 min, 3â€“6 % bakke). Fit CdA/Crr fra data (uten powermeter).
Lagre pr sykkel/profil; bruk globalt i beregninger.
DoD: Reproducible fit pÃ¥ testdata; MAE â‰¤10 % mot powermeter pÃ¥ kalibreringssegment; flagg â€œKalibrert: Ja/Neiâ€.
Status: âœ… Ferdig

S5 â€” Indoor pipeline + GPS/Wind integrasjon (ğŸ§ª)

Indoor/outdoor-pipeline koblet til fysikkmotor m/ vindkorrigering.
CLI-output: watts, wind_rel, v_rel, calibrated, status.
Bonus: Eksponert backend-API for frontend â€” cli/session_api.py: analyze_session() (+ tests/test_api.py), deterministisk JSON for enkel integrasjon i M8.
Golden test med syntetisk GPS+vindfelt etablert.
Unicode-bug i CLI lÃ¸st.
Tester: âœ… cargo/pytest grÃ¸nne, output stabil Â±1â€“2W.

Status: âœ… Ferdig
ğŸ”§ Dynamisk DoD (mÃ¥ alltid vÃ¦re oppfylt)
Robust CLI: Alle subcommands (session, efficiency) kjÃ¸rer uten runtime-feil pÃ¥ gyldige inputfiler.
Profiler: profile.json lagres/lastes; felt calibrated, cda, crr, calibration_mae oppdateres ved kalibrering.

Kalibrering:
MAE â‰¤ 10 % pÃ¥ kalibreringssegment mot powermeter.
Output markerer calibrated: Ja/Nei + reason (nulles ut ved suksess).
Fysikk: Bruker physics-output som baseline (NP/avg, smoothing).
Determinisme: Samme input gir samme output (Â±1â€“2 W).
Tester: cargo test + pytest mÃ¥ vÃ¦re grÃ¸nne i CI.
Observabilitet: CLI og API viser nÃ¸kkelfelter (effektivitet, NP, IF, VI, Pa:Hr, W/beat, kalibrering).
Integrasjon: Rust-kjerne eksponert til Python via PyO3 (analyze_session, rust_calibrate_session).

Nytt (A): Konsistensregler i output
Hvis calibrated=True â†’ reason=None.
NÃ¥r GPS/vind brukes â†’ mode="outdoor".
status avledes fra HR nÃ¥r mulig (ellers behold LIMITED).


S6 â€” CLI/Reports & observabilitet (ğŸ“ˆ)
Rapportfelt: NP, Avg, VI, Pa:Hr, W/beat, PrecisionWatt Â±usikkerhet.
Strukturerte logger (level, tidsbruk, cache hits).

Metrics for no-watt (sessions_no_power_total).
Generere rapporter (CSV/JSON) med trender.
Historikk over kalibrering og WPB baseline.
Docs: â€œHow it worksâ€ + â€œKnown limitsâ€.
DoD: deterministisk rapport; loggnivÃ¥ styrbart via flagg/env.

S7 â€” QA & hardening (ğŸ›¡ï¸)
Edge-cases: manglende vÃ¦r, GPS-drift, null HR, kort Ã¸kt.
Flere golden-tester med variasjon i vÃ¦r/terreng.
Golden pÃ¥ ekte ride uten powermeter + plausibilitet mot HR/trend.
OppdatÃ©r CGS v1.1-kobling.
Nytt (B): RefaktorÃ©r testoppsett (conftest.py, test_utils.py) for mindre mocking-knot.
DoD: alle tester grÃ¸nne; CGS konsumerer nye felter uten regress.




S8 â€” Scaffold & dataadapter (ğŸ§©)

React/Tailwind scaffold, routing, state.
Bruk eksisterende Python-API analyze_session() som backend-adapter (forenkler integrasjon).
Nytt: sÃ¸rge for at frontend alltid forventer schema_version i output og hÃ¥ndterer HR-only fallback.

DoD:
Viser Ã©n Ã¸kt (mock) i UI; bytte mockâ†’live via .env.
JSON-output fra backend valideres mot schema_version.
HR-only fallback vises uten crash i UI.


S8.5 â€” Mini-sprint: Precision Watt stubs + short-session guard (ğŸ§©)
Status: âœ… Ferdig

Oppgaver
Utvidet SessionReport med: precision_watt, precision_watt_ci, sources, cda, crr, reason (nullable).
Oppdatert mockSession med dummy-serier (40 samples).
Dev-sanity i SessionView (kun DEV): teller PW/CI samples.
Short-session guard (<30 samples): kontrollert melding, ingen crash.

DoD
App bygger grÃ¸nt med nye felter.
Dev-sanity synlig i DEV.
Kort-Ã¸kt gir kontrollert beskjed.

S9 â€” Ã˜kt-kort & nÃ¸kkelmetrikker (ğŸ“Š)
SessionCard viser NP, IF, VI, Pa:Hr, W/slag, CGS og PrecisionWatt-verdi.
Indoor/Outdoor-chip og Kalibrert-status i UI; ryddigere navigasjon.
Short-session guard (<30 samples) med kontrollert melding; HR-only fallback stÃ¸ttes uten crash.
MockSession oppdatert (outdoor/indoor-varianter); konsistent rendering.
DoD: NÃ¸kkelmetrikker vises korrekt i UI, kort-Ã¸kt og HR-only hÃ¥ndteres uten crash, prod-build verifisert, tester grÃ¸nne.

ğŸ” Dynamisk DoD & Frontlog (oppdatert etter S11)
âœ… FERDIG â€“ S9 â€” Ã˜kt-kort & nÃ¸kkelmetrikker (ğŸ“Š)

Status: Ferdig
Leveranser:
SessionCard viser NP, IF, VI, Pa:Hr, W/slag, CGS og PrecisionWatt-verdi.
Indoor/Outdoor-chip og Kalibrert-status i UI med ryddigere navigasjon.
Kort-Ã¸kt (<30 samples) gir kontrollert beskjed; HR-only fallback stÃ¸ttes uten crash.
MockSession oppdatert (outdoor/indoor-varianter); konsistent rendering.
DoD: NÃ¸kkelmetrikker vises korrekt i UI; kort-Ã¸kt og HR-only hÃ¥ndteres uten crash; prod-build verifisert; tester grÃ¸nne.

âœ… FERDIG â€“ S10 â€” Live API-integrasjon (ğŸŒ)

Oppgaver (levert):
api.ts med timeout/abort + schema-guard (+ simulateInvalid dev-switch).
sessionStore med kildevalg (api/mock), identisk state-shape og robust feilflyt.
ErrorBanner + â€œPrÃ¸v igjenâ€ i SessionView; uendret layout for mock/live.
.env.example (VITE_BACKEND_URL).
Vitest for ErrorBanner/SessionView/store; jsdom-oppsett.

DoD (bestÃ¥tt):
Live-Ã¸kt hentes og rendres uten crash.
Mock-data fortsatt brukbare i dev.
Feiltilstander (offline/timeout/404/500) â†’ banner + retry.
Prod/dev viser identisk layout.
Typecheck/build/test grÃ¸nt.

Funn (A/B/C):

A (DoD): 404 â†’ â€œIngen data Ã¥ viseâ€; 500/timeout â†’ generisk feil. Schema-guard fail-closed.

B (Frontlog): Rebuild-script for Rust-kjerne; CI-steg for maturin + cache; doc for venv/VSCode-interpreter.

C (Observasjon): Pytest feilet pga. tolkermismatch (conda â†” system). LÃ¥s til prosjekt-venv og unngÃ¥ ../src/...-imports i src/*.

âœ… FERDIG â€“ S11 â€” Analysepanel & trender (ğŸ“ˆ)
Oppgaver (fullfÃ¸rt):
AnalysisPanel med status-badges (FULL, HR-only, LIMITED).
AnalysisChart med CI-bÃ¥nd (PrecisionWatt), tooltip og NP/PW-trend.
Edge-case-hÃ¥ndtering (kort Ã¸kt, kalibrert =false, tomme data).
Tooltip viser Kilde og Kalibrert.
CI-bÃ¥nd vises/skjules (kontrollert; test midlertidig skipâ€™et men patch klar).
Tester for hover, fallback og smoke; ytelse testet (1 Hz / 2 t).
Prod/dev layout verifisert identisk.
Lint + type-check + build/test grÃ¸nt.

DoD (bestÃ¥tt):
Analysepanel gir innsikt og er robust.
Trendgraf fungerer med edge-case-data.
CI-bÃ¥nd og tooltip interaktive og korrekte.
Feiltilstander gir fallback og banner.
Prod og dev identisk ytelse.
Type-sikkerhet 100 %.
Funn (A/B/C):
A (DoD): Legg til visuell indikator ved kalibrert =false (i tooltip/legend).
B (Frontlog): Opprett egen TrendsChart for aggregert NP/PW over flere Ã¸kter (videresatt til S12).
C (Observasjon): Test for CI-bÃ¥nd skipâ€™et i CI â†’ patch planlagt i S12.

ğŸ”œ PLANLAGT â€“ S12 â€” Brukeropplevelse & kalibreringsguide (ğŸ¨ğŸ§­)

Oppgaver:
Onboarding for fÃ¸rste outdoor-Ã¸kt; stegvis kalibreringsmodal.
Info for brukere uten wattmÃ¥ler (HR-fallback, tydelig sprÃ¥k).
Rydd labels; skille Mode (Indoor/Outdoor) vs. Kilde (API/Mock).
Knytte til schema-felter (calibrated, cda, crr, reason).
Ny fra S11: TrendsChart for aggregert NP/PW â†’ inkluderes i UI-oversikt.
[ny prosessforbedring] Legg inn fast bygg- og import-sjekk fÃ¸r push:
python -m maturin develop --release -F python --manifest-path core/Cargo.toml && python -c "import cyclegraph_core"
slik at cyclegraph_core alltid kompileres og importeres korrekt fÃ¸r pytest/CI kjÃ¸rer.

DoD (presisert):
â€œFerdig kalibrertâ€ trigger backend-flag og speiles i UI.
HR-only-flyt forstÃ¥elig uten tekniske termer.
TrendsChart viser NP/PW per Ã¸kt uten lagg.
Enhetstester pÃ¥ nye UI-komponenter; samme feilbanner-mÃ¸nster ved svikt.
Bygg- og import-sjekk for cyclegraph_core mÃ¥ kjÃ¸re grÃ¸nt fÃ¸r merge.

ğŸ”œ S13 â€” QA, Polish, CI & Definition of Truth (ğŸš€âœ…)
MÃ¥l
Kvalitetssikre hele kjeden, etablere Definition of Truth, innfÃ¸re schema-kontrakter og fÃ¸rste live-kobling av TrendsChart.
Oppgaver
Kvalitet / QA
Tilgjengelighet (a11y: kontraster, tastaturnavigasjon).
Verifiser kalibrerings-flow fra S12 i Lighthouse (UX > 80).
Sanity-test kjÃ¸res kun ved publisering.
MiljÃ¸hensyn: unngÃ¥ npm ci i OneDrive â†’ bruk npm install eller flytt mappe.
QA-sjekk: CI validerer at cyclegraph_core kan importeres, og at pytest kjÃ¸rer 52 tester.
CI / Testing

GitHub Actions: Rust toolchain (MSVC) + maturin build.
KjÃ¸r: pytest (CLI), vitest (FE), schema-kontrakter.
Logging-test i CI: stdout = ren JSON, stderr = debug/log.
Kontrakttest for /api/trends mot trends_response.v1.json.
Definition of Truth
docs/definition-of-truth.md:

Kilde â†’ avledet â†’ rull-up: sessions â†’ session_metrics â†’ daily_user_metrics.
Begreper: w_per_beat, pw_efficiency, HR-fallback.
Tid/lagring: UTC som sannhet; presentasjon kan mappe til Europe/Oslo ved behov.
Versjonering: schema_version = 0.7.x.
JSON-schemaer:
schema/session_metrics.v1.json
schema/daily_user_metrics.v1.json
schema/trends_response.v1.json
Lett validator i CI (ajv/TS).
Trend Analysis (minimal patch)
Backend: /api/trends?from&to&bucket=day (les fra daily_user_metrics, eller tom struktur hvis ingen data).
Frontend: mock â†’ live bak feature-toggle VITE_USE_LIVE_TRENDS=true.
â€œIngen data ennÃ¥â€-state + robust AbortError-hÃ¥ndtering.
Docs: nytt avsnitt om TrendsChart i Using Precision Watt.

DoD
Lighthouse: Perf > 80, a11y > 90.
CI grÃ¸nn inkl. maturin + schema-kontrakter + logging-test.
/api/trends returnerer 200 med korrekt struktur (ogsÃ¥ tom respons).
pytest + cargo + vitest bestÃ¥r; cyclegraph_core import-sjekk OK (52 tester).
Prod-build stabil; ingen manuelle rebuild-steg.

Estimat
QA/Lighthouse/a11y: 2â€“3 t
CI/schema-validering: 2â€“3 t
DoT + docs: 2 t
Trend-patch (BE+FE): 2â€“4 t
Sum: 8â€“12 t

ğŸ”œ S13 â€” QA, Polish, CI & Definition of Truth (ğŸš€âœ…)
Status: âœ… Ferdig
ğŸ¯ MÃ¥l
Kvalitetssikre hele kjeden, etablere Definition of Truth, innfÃ¸re schema-kontrakter og fÃ¸rste live-kobling av TrendsChart.
ğŸ§ª Oppgaver

Kvalitet / QA
âœ… Tilgjengelighet (a11y: kontraster, tastaturnavigasjon) verifisert.
âœ… Kalibrerings-flow fra S12 testet i Lighthouse (UX-score: Performance 74 âš ï¸, Accessibility 90 âœ…, Best Practices 100 âœ…, SEO 82 âœ…).
âœ… Sanity-test utfÃ¸rt ved publisering.
âœ… MiljÃ¸hÃ¥ndtering OK â€“ npm install brukt, ikke npm ci i OneDrive.
âœ… QA-sjekk bekrefter at cyclegraph_core kan importeres og at pytest kjÃ¸rer alle 52 tester.
CI / Testing

âœ… GitHub Actions kjÃ¸rer Rust toolchain (MSVC) + maturin build.
âœ… pytest, cargo test og vitest fullfÃ¸rt grÃ¸nt.
âœ… Schema-kontrakter valideres via ajv-cli.
âœ… Logging-test i CI gir ren JSON til stdout og debug til stderr.
âœ… Kontrakttest for /api/trends mot trends_response.v1.json fungerer korrekt.
Definition of Truth

âœ… docs/definition-of-truth.md etablert:
Datakjede: sessions â†’ session_metrics â†’ daily_user_metrics.
Begreper definert: w_per_beat, pw_efficiency, HR-fallback.
Tid/lagring: UTC som sannhet, lokal mapping til Europe/Oslo.
Versjonering: schema_version = 0.7.x.

âœ… JSON-schemaer:
schema/session_metrics.v1.json
schema/daily_user_metrics.v1.json
schema/trends_response.v1.json
âœ… Lett validator i CI (ajv/TypeScript).

Trend Analysis (minimal patch)

âœ… Backend: /api/trends?from&to&bucket=day leser fra daily_user_metrics og returnerer tom struktur hvis ingen data.
âœ… Frontend: mock â†’ live bak feature-toggle VITE_USE_LIVE_TRENDS=true.
âœ… â€œIngen data ennÃ¥â€-state og robust AbortError-hÃ¥ndtering implementert.
âœ… Dokumentasjon oppdatert med nytt avsnitt om TrendsChart i Using Precision Watt.
âœ… DoD-verifikasjon
Kriterium	Resultat
Lighthouse	Performance 74 âš ï¸, Accessibility 90 âœ…, Best Practices 100 âœ…, SEO 82 âœ…
CI (maturin + schema + logging)	âœ… GrÃ¸nn
/api/trends struktur	âœ… 200 + gyldig respons (inkl. tom)
pytest + cargo + vitest	âœ… Alle tester passert (52 totalt)
Prod-build	âœ… Stabil uten manuelle rebuilds
â±ï¸ Estimat (faktisk brukt)
QA/Lighthouse/a11y: ~3 t
CI/schema-validering: ~3 t
DoT + docs: ~2 t
Trend-patch (BE + FE): ~3 t
Sum: â‰ˆ 11 t

ğŸ†• Dynamisk DoD â€” Sprint 14.5: Precision Watt E2E (Backend fullfÃ¸ring + verifikasjon)
ğŸ¯ MÃ¥l
Ferdigstille backend E2E for Precision Watt slik at alle fem Ã¸ktene (ride1â€“5) kan analyseres med vÃ¦r + profil, persisteres, og (valgfritt) publiseres til Strava â€“ idempotent, robust og uten mock. Samtidig: profil/kalibrering i backend, auto-refresh av Strava-token, og stÃ¸tte for Ã¸kter opptil 5 timer.
âœ… Gjort i S14 (flyttet status)
API oppe (127.0.0.1:5179), app.py laster .env (dotenv), debug-endepunkter finnes.
Token-flyt reetablert (authorize â†’ code â†’ token).
ride3 publisert med Precision Watt â‰ˆ 225 W (Strava viste 198 W).
Publish-pipeline kjÃ¸rer; toggles leses; ride1/2/4/5 publiserte kun Stravaâ€™s tall (manglende analyze).
Hjelpeskript for start/publish/auth etablert.
ğŸ“¦ Omfang (leveranser)
Backend (Rust/Python)
VÃ¦rdata i analysen: analyze_session() henter vindstyrke/retning, temp, trykk â†’ lufttetthet (Ï); kobler GPS-heading â†” vindvinkel; brukes i PW-formelen.
Profil + defaults: hvis profil mangler â†’ bruk dokumenterte safe defaults (rider_weight, bike_type, bike_weight, tire_width, tire_quality). NÃ¥r profil finnes â†’ overstyr defaults.
Profil/kalibrering i backend: lagre/laste profil (JSON/fil-DB), bruke verdiene i analyse (total masse + Crr avledet fra dekk-kvalitet/bredde).
Sessions 1â€“5: kjÃ¸r analyze for alle fem; persister:
precision_watt, precision_watt_ci, cda, crr_used, reason, publish_state, publish_hash.
Idempotent publish: publish_hash = sha256(activity_id | pw | ci) â†’ hopp over duplikat.
Auto-refresh Strava token: ved 401/utlÃ¸p â†’ bruk refresh_token, oppdater .env (access/refresh/expires_at), retry.
Ã˜ktlengde: stÃ¸tte â‰¤ 5 timer @ 1 Hz med timeout/chunk-guards.
Publish-tekst: inkluder nÃ¸yaktig:
Check out my full ride analysis at CycleGraph.app
Lagring/Observabilitet
Schema v0.7.3 (additivt): bike_type, bike_weight, tire_width, tire_quality, rider_weight, crr_used, precision_watt, precision_watt_ci, publish_state, publish_hash, published_to_strava, publish_time, consent_*.
Metrikker: pw_publish_success_total, pw_publish_fail_total.
Logger: strukturert Import â†’ Analyze â†’ Persist â†’ Publish (med tidsbruk/resultat).
API (MÃ… vÃ¦re i drift i S14.5)
POST /api/sessions/:id/analyze
POST /api/sessions/:id/publish
GET /api/profile/get
POST /api/profile/set â† brukes i S14.5 for Ã¥ verifisere at profil pÃ¥virker beregning
GET /api/health, GET /api/debug/token_present
CLI/Script
scripts/tools/start_api.ps1
scripts/tools/publish_ride.ps1
scripts/tools/strava_reauth.ps1
ğŸ§ª DoD (sjekkliste)
Funksjonelt
 analyze_session() bruker vÃ¦r (inkl. vindvinkel og Ï) i PW (ikke mock).
 Profil pÃ¥virker beregningen: defaults ved fravÃ¦r; profilverdier overstyrer defaults.
 ride1â€“5: etter analyze har data/sessions/*.json PW + CI + CdA + Crr_used + reason (ikke bare Stravaâ€™s tall).
 Publish idempotent (hash), 401â†’auto-refresh + retry, 429â†’backoff.
 StÃ¸tter â‰¤ 5 timer datasett uten jank/feil.
 Publish-kommentar inkluderer â€œCheck out my full ride analysis at CycleGraph.appâ€.
Observabilitet & persist
 Schema v0.7.3 validerer (additivt, bakoverkompatibelt).
 Logger viser hver fase + varighet; metrikker Ã¸kes korrekt.
Token & robusthet
 refresh_token-flyt oppdaterer .env (access/refresh/expires_at).
 /api/debug/token_present â†’ ok:true under drift; publish tÃ¥ler access-utlÃ¸p.
Profil-verifikasjon (S14.5-krav)
 POST /api/profile/set med realistiske verdier fÃ¸r analyze.
 Re-analyze ride1â€“5 â†’ PW/Crr_used/CdA endrer seg konsistent ift. defaults.
ğŸ§ª AkseptansekjÃ¸ring (kommandoer)
Start API (vindu A)
powershell -NoProfile -ExecutionPolicy Bypass -File .\scripts\tools\start_api.ps1 -Port 5179
Helse/token (vindu B)
Invoke-RestMethod http://127.0.0.1:5179/api/health
Invoke-RestMethod http://127.0.0.1:5179/api/debug/token_present
Sett profil (pÃ¥virker masse/Crr)

$body = @{
  rider_weight_kg = 103
  bike_weight_kg  = 9.5
  bike_type       = "road"
  tire_width_mm   = 28
  tire_quality    = "gp5000"
  bike_name       = "Canyon Endurace"
} | ConvertTo-Json
Invoke-RestMethod -Method Post -ContentType "application/json" `
  -Uri http://127.0.0.1:5179/api/profile/set -Body $body


Analyze alle 5
1..5 | % { Invoke-RestMethod -Method Post "http://127.0.0.1:5179/api/sessions/ride$_/analyze" }
Verifiser persist (eksempel ride3)
Get-Content .\data\sessions\ride3.json -Raw | ConvertFrom-Json |
  Select session_id, precision_watt, precision_watt_ci, crr_used, cda, reason, publish_state | Format-List
Publish alle 5 (idempotent + riktig kommentar)
1..5 | % { Invoke-RestMethod -Method Post "http://127.0.0.1:5179/api/sessions/ride$_/publish" }
Forventning (profil-effekt):
precision_watt skal endre seg vs. fÃ¸r profil; crr_used reflekterer dekk-kvalitet/bredde; vÃ¦r (Ï/vindvinkel) pÃ¥virker PW.
ğŸ”¦ (Valgfritt) Tynn FE-smoke i S14.5 â€“ for trygg overgang til S15
 Frontend henter live /api/sessions/:id og viser PW/CI i SessionCards (VITE_USE_MOCK=false).
 TrendsChart kaller /api/trends og hÃ¥ndterer tom respons uten crash.
 Responsiv layout â€“ enkel manuell sjekk (mobilbredde).
(Full profil-UI, toggles og komplett FE-synlighet ligger i S15.)
ğŸ§¯ Troubleshooting (kort)
has_token=False / mangler STRAVA_ACCESS_TOKEN â†’ start server fra repo-rot, ha load_dotenv(override=True) Ã¸verst i app.py.
404 etter authorize â†’ ok ved manuell code (evt. legg /api/debug/oauth_capture).
Port i bruk â†’ netstat -ano | findstr :5179 â†’ taskkill /PID <PID> /F.
Tom publish-respons i PS5.1 â†’ endpoint kan returnere 204; bruk publish_ride.ps1.
from __future__ syntax error â†’ mÃ¥ stÃ¥ helt Ã¸verst i fila.
ğŸ“Œ Commit/tag-forslag
git add .
git commit -m "S14.5: Backend PW E2E: weather+profile in analyze, schema v0.7.3 persist, idempotent publish w/ token auto-refresh, 5h guard, logs/metrics."
git tag -a v0.14.5 -m "Sprint 14.5 E2E PW backend complete"git push --follow-tags


# ğŸ§© Sprint 15 â€” Frontend integrasjon, trend & visuell polish (cyclegraph.app)

**Periode:** 10.â€“24. november 2025
**Tema:** Koble **frontend â†â†’ backend** slik at brukeren ser **ekte analyserte data (ikke mock)** i Session Cards og Trend. Samtidig migrerer vi landingssiden til **cyclegraph.app** (Vercel) med tosprÃ¥klig innhold, riktig SEO/OG og **>90 Lighthouse**. Alt skal se minimalistisk og helhetlig ut, og lÃ¸fte fram det solide arbeidet i backend.

---

## ğŸ¯ MÃ¥l

1. Live-data i UI (Session Cards, Trend, Ã˜kt-detalj) â€” **ingen mock**.
2. Profil/kalibrering UI â†’ re-analyze viser endring i **Precision Watt**.
3. Migrere landingsside til **cyclegraph.app** (Vercel), **NO/EN** og SEO.
4. Observabilitet i UI: feilbanner, activity-log, enkle timings.

---

## ğŸ“¦ Omfang (leveranser)

### Frontend (React/TS/Vite)

**Datakilde:** live API (ingen mock).

**Nytt datalag `src/lib/api.ts` med:**

* `listSessions()`, `getSession(id)`, `analyze(id, opts)`
* `getTrendSummary()`, `getTrendPivot(metric, profileVersion)`
* `getProfile()`, `saveProfile(payload)`

**Behold eksisterende komponenter/hover** â€“ bytt **mock â†’ api.ts** via adaptere.

#### Session Cards (UI)

Viser: `precision_watt (PW)`, `PW_CI` (nÃ¥r tilgjengelig), `CdA`, `crr_used`, `publish_status (done/failed/pending/none)`, `publish_time`, Strava-lenke.

#### Trend (enkel)

To kurver: **Avg Watt** og **Watt per Heartbeat (W/Beat)** over siste N Ã¸kter.
Data hentes fra `trend9_trend_summary.csv` og pivots via API-endepunkter.

#### Ã˜kt-kurve (detalj)

PÃ¥ klikk: vis tidsserie med hover for â€œsanntid wattâ€ (bruk eksisterende hoverâ€logikk, men feed **live samples**).

#### Profil/kalibrering UI

Felter: `rider_weight_kg`, `bike_type`, `bike_weight_kg`, `tire_width_mm`, `tire_quality`, `bike_name`, **`cda` (default 0.30)**.
**Ikke redigerbar:** `crank_efficiency` (**96%** â€” styres av backend/eksperimenter).
Samtykke: versjon + tidsstempel.
Toggle: â€œPublisÃ©r Precision Watt til Stravaâ€.

#### Onboarding-visuals (MVP-stubber)

* `TirePreview`: responsiv illustrasjon av dekk som endrer dimensjon ved dropdown.
* `RiderAvatar`: realistisk/minimalistisk avatar m/sykkel (placeholderâ€stil).
* `ProfileAccuracyMeter`: indikator som starter **~15â€“20 %** usikkerhet og synker mot **~3â€“5 %** etter hvert som felter fylles (MVP-heuristikk).
  Styres av feature-flag **`VITE_FEAT_VISUALS=1`**.

#### UI/UX

* A11y: labels, fokus, tastatur.
* Felles `<ApiErrorBanner />` for 401/403 m/tekst **â€œKoble Strava pÃ¥ nyttâ€**.
* â€œActivity logâ€ i UI: siste analyze/publish med timestamp.

### Migrering â€” cyclegraph.app (Vercel)

* Flytt alt fra `landing/` inn i repoet (f.eks. `frontend/app/landing`).
* Konsolider i18n (NO/EN), oppdatÃ©r meta/OG/favicons, responsiv layout.
* Deploy fra **main** (DNS verifisert for root + www).
* KjÃ¸r Lighthouse og fiks **>90** (SEO/Accessibility/Best Practices/Performance).

### Observabilitet (UI)

* UI-banner for feil (401/403/5xx).
* Enkle timings/labels i devtoolsâ€logs.

---

## ğŸ§  Viktig beslutning: Bygge videre, ikke slette

Vi **beholder** eksisterende komponenter (inkl. hoverâ€logikk) og layout som funker.

**Strategi:**

* Lag **adaptere** som mapper **backend â†’ dagens prop-shape**:

  * `mapSessionToCard(model)`
  * `mapSamplesToSeries(samples)`
  * `mapTrendCsvToSeries(csv)`
* Bytt **kun datakilden** fra mock â†’ `api.ts`.

Dette gir rask vei til â€œshineâ€, mindre teknisk gjeld, og trygg overgang.

---

## ğŸ”§ Implementasjonsplan (kort)

* Datalag: `src/lib/api.ts` + adaptere (se under).
* Session Cards: wire opp mot `listSessions()`/`getSession(id)`.
* Trend: les summary/pivots â†’ to kurver (AvgW, W/Beat).
* Ã˜kt-kurve: ved klikk, hent `samples` â†’ tegn kurve (gjenbruk hover).
* Profil: form + lagring (POST/PUT) â†’ **re-analyze** viser endring i PW.
* Visuals (flagget): `TirePreview`, `RiderAvatar`, `ProfileAccuracyMeter`.
* Migrering: landing â†’ cyclegraph.app + Lighthouse > 90.
* Polish: logo i header, spacing/typografi, tooltips.

---

## ğŸ§± API-kontrakter (referanse)

> Kontraktene speiler Trinn 9 â€œKontraktssikring & scalar-metricsâ€. Backend fyller **kun manglende nÃ¸kler**; den **overskriver ikke** tall felt som finnes.

**Response toppnivÃ¥ (eksempel):**

```json
{
  "source": "rust_core|fallback_py",
  "weather_applied": true,
  "profile_used": { "cda": 0.30, "crr": 0.004, "weight_kg": 104, "crank_efficiency": 96 },
  "metrics": {
    "precision_watt": 246.2,
    "drag_watt": 83.4,
    "rolling_watt": 29.7,
    "total_watt": 246.2,
    "weather_applied": true,
    "profile_used": { "cda": 0.30, "crr": 0.004, "weight_kg": 104, "crank_efficiency": 96 }
  },
  "samples": [ /* tidsserie */ ],
  "publish": { "status": "none|pending|done|failed", "time": "2025-11-12T08:15:30Z" }
}
```

**Trend summary (CSV) cols (eksempel):**

```
date, session_id, avg_watt, avg_hr, w_per_beat, cda_used, crr_used
```

**Profiler (eksempel payload):**

```json
{
  "rider_weight_kg": 104,
  "bike_weight_kg": 8.0,
  "bike_type": "road",
  "tire_width_mm": 28,
  "tire_quality": "gp5000",
  "bike_name": "Tarmac SL7",
  "cda": 0.30,
  "crank_efficiency": 96,
  "consent": { "version": 1, "ts": "2025-11-10T10:00:00Z" },
  "publish_to_strava": true
}
```

---

## âš™ï¸ Praktiske defaults (justerbare)

* **cda:** default **0.30** (skulder-/vinterhalvÃ¥r). Typisk spenn: 0.26â€“0.36 for road uten tempodrakt.
* **crank_efficiency:** default **96%** (lÃ¥st i UI; styres av backend/eksperimenter).
* **bike_weight_kg:** default 8.0 (typisk lett landeveissykkel 7.2â€“8.8 kg).
* **rider_weight_kg:** hent siste kjente profil ellers 80.0.
* **tire_width_mm:** road 28, gravel 40, mtb 55, tt 25.
* **tire_quality:** "gp5000" for road, "riddler" for gravel, "ikon" for mtb, "tt_slick" for tt.

> Disse er kun UI-defaults. Backend er kilde for sannhet ved analyze.

---

## ğŸ§© `src/lib/api.ts` (skjelett + typer)

```ts
// src/lib/api.ts
export type SessionId = string;

export interface Profile {
  rider_weight_kg: number;
  bike_weight_kg: number;
  bike_type: 'road' | 'gravel' | 'mtb' | 'tt';
  tire_width_mm: number;
  tire_quality: string;
  bike_name?: string;
  cda?: number; // aerodynamic drag area, default 0.30 (seasonal)
  crank_efficiency?: number; // default 96, not editable by user
  consent?: { version: number; ts: string };
  publish_to_strava?: boolean;
}

export interface SamplePoint {
  t: number;      // seconds from start
  watt: number;   // precision watt
  hr?: number;    // bpm
}

export interface AnalyzeMetrics {
  precision_watt: number;
  drag_watt: number;
  rolling_watt: number;
  total_watt: number;
  weather_applied: boolean;
  profile_used?: Partial<Profile>;
}

export interface PublishInfo {
  status: 'none' | 'pending' | 'done' | 'failed';
  time?: string;
  strava_url?: string;
}

export interface AnalyzeResponse {
  source: string;
  weather_applied: boolean;
  profile_used?: Partial<Profile>;
  metrics: AnalyzeMetrics;
  samples?: SamplePoint[];
  publish?: PublishInfo;
}

const API_BASE = import.meta.env.VITE_API_BASE ?? 'http://127.0.0.1:8000/api';

async function http<T>(path: string, init?: RequestInit): Promise<T> {
  const res = await fetch(`${API_BASE}${path}`, {
    headers: { 'Content-Type': 'application/json' },
    credentials: 'include',
    ...init,
  });
  if (!res.ok) {
    const text = await res.text();
    throw new Error(`${res.status} ${res.statusText}: ${text}`);
  }
  return res.json() as Promise<T>;
}

export async function listSessions(): Promise<{ id: SessionId; name: string; ts: string; }[]> {
  return http('/sessions');
}

export async function getSession(id: SessionId): Promise<AnalyzeResponse> {
  return http(`/sessions/${id}`);
}

export async function analyze(id: SessionId, opts?: { no_weather?: boolean; force?: boolean; }): Promise<AnalyzeResponse> {
  const qs = new URLSearchParams();
  if (opts?.no_weather) qs.set('no_weather', '1');
  if (opts?.force) qs.set('force_recompute', '1');
  return http(`/sessions/${id}/analyze?${qs.toString()}`, { method: 'POST', body: '{}' });
}

export async function getTrendSummary(): Promise<string> { // CSV string
  const res = await fetch(`${API_BASE}/trend/summary.csv`, { credentials: 'include' });
  if (!res.ok) throw new Error(`Trend summary failed: ${res.status}`);
  return res.text();
}

export async function getTrendPivot(metric: 'avg_watt'|'w_per_beat', profileVersion?: number): Promise<string> {
  const qs = new URLSearchParams();
  if (profileVersion != null) qs.set('profile_version', String(profileVersion));
  const res = await fetch(`${API_BASE}/trend/pivot/${metric}.csv?${qs.toString()}`, { credentials: 'include' });
  if (!res.ok) throw new Error(`Trend pivot failed: ${res.status}`);
  return res.text();
}

export async function getProfile(): Promise<Profile> {
  return http('/profile');
}

export async function saveProfile(p: Profile): Promise<Profile> {
  return http('/profile', { method: 'PUT', body: JSON.stringify(p) });
}
```

---

## ğŸ” Adaptere (backend â†’ UI-props)

```ts
// src/lib/adapters.ts
import type { AnalyzeResponse, SamplePoint } from './api';

export function mapSessionToCard(r: AnalyzeResponse) {
  const m = r.metrics || ({} as any);
  return {
    precisionWatt: m.precision_watt ?? 0,
    pwCI: (m as any).pw_ci ?? null, // nÃ¥r tilgjengelig senere
    cda: (r.profile_used as any)?.cda ?? (m.profile_used as any)?.cda ?? 0.30,
    crr: (r.profile_used as any)?.crr ?? (m.profile_used as any)?.crr ?? null,
    crankEff: (r.profile_used as any)?.crank_efficiency ?? 96,
    publishStatus: r.publish?.status ?? 'none',
    publishTime: r.publish?.time ?? null,
    stravaUrl: r.publish?.strava_url ?? null,
    weatherApplied: r.weather_applied ?? m.weather_applied ?? false
  };
}

export function mapSamplesToSeries(samples: SamplePoint[]) {
  return (samples || []).map(s => ({ x: s.t, y: s.watt, hr: s.hr }));
}

export function mapTrendCsvToSeries(csv: string) {
  // Enkel CSVâ†’series (for Recharts). Kan byttes til Papaparse senere.
  const lines = csv.trim().split(/\r?\n/);
  const [header, ...rows] = lines;
  const cols = header.split(',');
  const idx = {
    date: cols.indexOf('date'),
    avg: cols.indexOf('avg_watt'),
    beat: cols.indexOf('w_per_beat')
  };
  return rows.map(line => {
    const c = line.split(',');
    return { date: c[idx.date], avg: Number(c[idx.avg]), beat: Number(c[idx.beat]) };
  });
}
```

---

## ğŸ§© Komponent-stubber

### `<ApiErrorBanner />`

```tsx
// src/components/ApiErrorBanner.tsx
import { AlertTriangle } from 'lucide-react';
export default function ApiErrorBanner({ message }: { message: string }) {
  return (
    <div className="border border-red-300 bg-red-50 text-red-800 p-3 rounded-2xl flex items-center gap-2">
      <AlertTriangle className="w-5 h-5" />
      <span>{message || 'Koble Strava pÃ¥ nytt'}</span>
    </div>
  );
}
```

### `<ActivityLog />`

```tsx
// src/components/ActivityLog.tsx
export type Activity = { ts: string; kind: 'analyze'|'publish'; detail?: string };
export default function ActivityLog({ items }: { items: Activity[] }) {
  return (
    <div className="text-sm space-y-1">
      {items.map((a, i) => (
        <div key={i} className="flex justify-between">
          <span className="opacity-70">{a.kind.toUpperCase()}</span>
          <span>{new Date(a.ts).toLocaleString()}</span>
        </div>
      ))}
    </div>
  );
}
```

### `<SessionCard />`

```tsx
// src/components/SessionCard.tsx
import ActivityLog from './ActivityLog';

export default function SessionCard({ s }: { s: any }) {
  return (
    <div className="rounded-2xl shadow p-4 grid gap-2">
      <div className="text-xl font-semibold">{s.name ?? 'Session'}</div>
      <div className="grid grid-cols-2 gap-2 text-sm">
        <div>PW: <b>{Math.round(s.precisionWatt)}</b> W</div>
        <div>CdA: {s.cda ?? 'â€”'}</div>
        <div>CRR: {s.crr ?? 'â€”'}</div>
        <div>Crank eff: {s.crankEff ?? 96}%</div>
        <div>Status: {s.publishStatus}</div>
      </div>
      <ActivityLog items={s.activity ?? []} />
    </div>
  );
}
```

### `<TrendChart />` (Recharts)

```tsx
// src/components/TrendChart.tsx
import { LineChart, Line, XAxis, YAxis, Tooltip, ResponsiveContainer } from 'recharts';

export default function TrendChart({ data }: { data: { date: string; avg: number; beat: number }[] }) {
  return (
    <div className="h-64">
      <ResponsiveContainer width="100%" height="100%">
        <LineChart data={data}>
          <XAxis dataKey="date" />
          <YAxis />
          <Tooltip />
          <Line type="monotone" dataKey="avg" dot={false} />
          <Line type="monotone" dataKey="beat" dot={false} />
        </LineChart>
      </ResponsiveContainer>
    </div>
  );
}
```

### `<ProfileForm />`

```tsx
// src/components/ProfileForm.tsx
import { useEffect, useState } from 'react';
import { getProfile, saveProfile, type Profile } from '@/lib/api';

// Enkle presets per sykkeltype + validering
const PRESETS: Record<NonNullable<Profile['bike_type']>, { tire_width_mm: number; bike_weight_kg: number }> = {
  road:  { tire_width_mm: 28, bike_weight_kg: 8.0 },
  gravel:{ tire_width_mm: 40, bike_weight_kg: 9.5 },
  mtb:   { tire_width_mm: 55, bike_weight_kg: 12.0 },
  tt:    { tire_width_mm: 25, bike_weight_kg: 8.2 },
};

function clampBikeWeight(x: number) { return Math.min(16, Math.max(5.5, x)); }
function clampCda(x: number) { return Math.min(0.5, Math.max(0.18, x)); }

export default function ProfileForm() {
  const [p, setP] = useState<Profile | null>(null);
  const [saving, setSaving] = useState(false);
  const [err, setErr] = useState<string | null>(null);

  useEffect(() => { getProfile().then(v => setP({ cda: 0.30, crank_efficiency: 96, ...v } as Profile)).catch(e => setErr(e.message)); }, []);

  if (err) return <div className="text-red-700">{err}</div>;
  if (!p) return <div>Loadingâ€¦</div>;

  const set = (k: keyof Profile, v: any) => setP({ ...p!, [k]: v });

  function onTypeChange(v: Profile['bike_type']) {
    const preset = PRESETS[v];
    setP({ ...p!, bike_type: v, tire_width_mm: preset.tire_width_mm, bike_weight_kg: preset.bike_weight_kg });
  }

  async function onSubmit(e: React.FormEvent) {
    e.preventDefault();
    setSaving(true);
    try {
      const clean: Profile = {
        ...p!,
        bike_weight_kg: clampBikeWeight(Number(p!.bike_weight_kg ?? 8.0)),
        cda: clampCda(Number(p!.cda ?? 0.30)),
        crank_efficiency: 96,
      };
      await saveProfile(clean);
    } catch (e: any) { setErr(e.message); }
    finally { setSaving(false); }
  }

  return (
    <form className="grid gap-3" onSubmit={onSubmit}>
      <label className="grid gap-1">
        <span>Rider weight (kg)</span>
        <input className="input" type="number" value={p.rider_weight_kg}
               onChange={e => set('rider_weight_kg', Number(e.target.value))} />
      </label>
      <label className="grid gap-1">
        <span>Bike weight (kg)</span>
        <input className="input" type="number" value={p.bike_weight_kg}
               onChange={e => set('bike_weight_kg', clampBikeWeight(Number(e.target.value)))} />
        <span className="text-xs opacity-70">Typisk road: 7.2â€“8.8 kg</span>
      </label>
      <label className="grid gap-1">
        <span>CdA</span>
        <input className="input" type="number" step="0.01" value={p.cda ?? 0.30}
               onChange={e => set('cda', clampCda(Number(e.target.value)))} />
        <span className="text-xs opacity-70">Default vinter/shoulder: 0.30 (typisk 0.26â€“0.36)</span>
      </label>
      <label className="grid gap-1">
        <span>Tire width (mm)</span>
        <input className="input" type="number" value={p.tire_width_mm}
               onChange={e => set('tire_width_mm', Number(e.target.value))} />
      </label>
      <label className="grid gap-1">
        <span>Tire quality</span>
        <input className="input" value={p.tire_quality}
               onChange={e => set('tire_quality', e.target.value)} />
      </label>
      <label className="grid gap-1">
        <span>Bike type</span>
        <select className="input" value={p.bike_type} onChange={e => onTypeChange(e.target.value as any)}>
          <option value="road">Road</option>
          <option value="gravel">Gravel</option>
          <option value="mtb">MTB</option>
          <option value="tt">TT</option>
        </select>
      </label>
      <label className="grid gap-1">
        <span>Crank efficiency</span>
        <input className="input" type="number" value={96} readOnly />
        <span className="text-xs opacity-70">LÃ¥st i UI â€” styres av backend/eksperimenter</span>
      </label>
      <label className="grid gap-1">
        <span>Publish to Strava</span>
        <input type="checkbox" checked={!!p.publish_to_strava}
               onChange={e => set('publish_to_strava', e.target.checked)} />
      </label>
      <button className="btn" disabled={saving}>{saving ? 'Savingâ€¦' : 'Save profile'}</button>
    </form>
  );
}
```

---

## ğŸ§­ Router/wiring (enkelt eksempel)

```tsx
// src/app/App.tsx
import { useEffect, useState } from 'react';
import { listSessions, getSession, analyze, getTrendSummary } from '@/lib/api';
import { mapSessionToCard, mapTrendCsvToSeries } from '@/lib/adapters';
import SessionCard from '@/components/SessionCard';
import TrendChart from '@/components/TrendChart';
import ApiErrorBanner from '@/components/ApiErrorBanner';

export default function App() {
  const [sessions, setSessions] = useState<any[]>([]);
  const [trend, setTrend] = useState<any[]>([]);
  const [err, setErr] = useState<string | null>(null);

  useEffect(() => {
    listSessions()
      .then(async (rows) => {
        const detailed = await Promise.all(rows.slice(0, 5).map(async r => mapSessionToCard(await getSession(r.id))));
        setSessions(detailed);
      })
      .catch(e => setErr(e.message));

    getTrendSummary()
      .then(csv => setTrend(mapTrendCsvToSeries(csv)))
      .catch(e => setErr(e.message));
  }, []);

  return (
    <div className="max-w-5xl mx-auto p-6 grid gap-6">
      {err && <ApiErrorBanner message={err} />}
      <h1 className="text-2xl font-bold">CycleGraph</h1>
      <TrendChart data={trend} />
      <div className="grid md:grid-cols-2 gap-4">
        {sessions.map((s, i) => <SessionCard key={i} s={s} />)}
      </div>
    </div>
  );
}
```

---

## ğŸŒ MiljÃ¸ & build

**.env.example**

```
VITE_API_BASE=http://127.0.0.1:8000/api
VITE_FEAT_VISUALS=1
```

**Vite config (hint)**
SÃ¸rg for `@` alias â†’ `src/` og riktig basepath.

---

## ğŸŒ i18n stub (NO/EN)

```
src/i18n/no.json
src/i18n/en.json
src/lib/i18n.ts  // liten util + hook
```

---

## ğŸ§ª DoD (sjekkliste)

**Funksjonelt**

* Session Cards viser verdier fra **ekte analyse** (PW, CI, CdA, crr_used, publish-status/tid, crank eff 96%).
* Trend viser **Avg Watt** og **W/Beat** (minst 5 Ã¸kter, ekte data).
* Ã˜kt-kurve med hover fungerer pÃ¥ **live samples**.
* Profil kan lagres; ny **analyze** bruker verdiene (verifiser ved Ã¥ endre dekk).
  **CdA = 0.30** default reflekteres i analyze.
* Publish-toggle: respekteres av backend.
* **Crank efficiency:** ikke brukerredigerbar (**lÃ¥st 96%**).

**Migrering**

* cyclegraph.app (og www) viser **ny landingsside** fra main-repo.
* NO/EN toggle fungerer; meta/OG/favicons riktig.
* Lighthouse **SEO/Acc > 90** (logges i `docs/deployment-log.md`).

**Ingen mock**

* Alle API-kall gÃ¥r mot live endpoints. â€œDummyâ€/mock slÃ¥tt av/ryddet.

**AkseptansekjÃ¸ring**

* Ã…pne frontend (`npm run dev`) â†’ Session Cards viser data for **ride1â€“5**.
* Endre profil (f.eks. `tire_quality`) â†’ **re-analyze ride3** â†’ PW endres konsistent.
* SlÃ¥ pÃ¥ publish-toggle â†’ publisering skjer ved neste analyze/publish; kommentar inkluderer:
  *â€œCheck out my full ride analysis at CycleGraph.appâ€*.
* Lighthouse-rapport >90 (lagres i `docs/deployment-log.md`).

---

## ğŸ§¯ Troubleshooting (kort)

* **401/403** â†’ â€œKoble Strava pÃ¥ nyttâ€ (UI-banner).
* **Port i bruk** â†’ `netstat -ano | findstr :5175` â†’ `taskkill /PID <PID> /F`.
* **from-future-imports** mÃ¥ stÃ¥ helt Ã¸verst (JS/TS: Vite config).
* **PS 5.1/UTF8-BOM**: bruk `utf8/utf8-sig` der vi skriver JSON/CSV (backend/trend9 matcher).

---

## ğŸ—ºï¸ (Frivillig) Sprint 16 â€” â€œPolish & Launchâ€

**MÃ¥l:** Polish + release hygiene etter S15.
**Omfang:** Release notes, README (Quick Start + Troubleshooting + Scripts), E2E-script (importâ†’analyzeâ†’publish), telemetri labels/timing, UI-feiltekster, sitemap/robots/canonical.
**DoD:** `/docs/launch-playbook.md`, demo-flyt testet end-to-end, alt grÃ¸nt i CI.




git add .
git commit -m "Lock S13â€“S15 frontlog: DoT, trends, PW E2E + Bike Setup, i18n migration"
git push